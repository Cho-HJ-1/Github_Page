<!-- update: keep list-style layout + hero card, add analysis (weights/age) in detail, switch all doughnut charts to horizontal stacked bars -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëŒ€í•œë¯¼êµ­ ì§„ì§œ ì—¬ë¡  MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" as="style" crossorigin="" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background-color: #F5F7FA; }
    .card { box-shadow: 0 18px 50px -24px rgba(15, 23, 42, 0.4); }
    .pulse-dot { box-shadow: 0 0 0 rgba(59,130,246,0.4); animation: pulse 1.8s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.35); } 70% { box-shadow: 0 0 0 14px rgba(59,130,246,0); } 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); } }
    .page-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
    .fade-enter { opacity: 0; transform: translateY(10px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); }
    .bar-fill { transition: width 0.5s ease; }
  </style>
</head>
<body class="bg-[#F5F7FA] text-gray-900 min-h-screen pb-20">
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- ë¡œê·¸ì¸ / íšŒì›ê°€ì… (Mock) -->
  <div id="login-modal" class="fixed inset-0 bg-black/70 text-white hidden items-center justify-center px-4 z-[140]">
    <div class="bg-white text-gray-900 rounded-3xl w-full max-w-md p-6 card space-y-4 relative">
      <div>
        <p class="text-xs text-blue-600 font-semibold mb-1">ì°¸ì—¬ ì „ ë¡œê·¸ì¸</p>
        <h2 class="text-xl font-bold leading-snug">ëŒ€í•œë¯¼êµ­ ì§„ì§œ ì—¬ë¡ ì— ì°¸ì—¬í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</h2>
        <p class="text-sm text-gray-600 mt-2">OAuthëŠ” ì‹œì—°ìš© Mock ì…ë‹ˆë‹¤. ì–´ë–¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ ê°€ì§œ ê³„ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="space-y-2">
        <button id="login-kakao" class="w-full py-3 rounded-xl bg-[#FEE500] text-gray-900 font-semibold shadow hover:translate-y-[-1px] transition">ì¹´ì¹´ì˜¤ë¡œ ê³„ì†í•˜ê¸°</button>
        <button id="login-naver" class="w-full py-3 rounded-xl bg-[#03C75A] text-white font-semibold shadow hover:translate-y-[-1px] transition">ë„¤ì´ë²„ë¡œ ê³„ì†í•˜ê¸°</button>
        <button id="login-google" class="w-full py-3 rounded-xl bg-white border border-gray-200 text-gray-800 font-semibold shadow hover:translate-y-[-1px] transition">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸°</button>
        <button id="login-email" class="w-full py-3 rounded-xl bg-gray-900 text-white font-semibold shadow hover:translate-y-[-1px] transition">ì´ë©”ì¼ë¡œ ê³„ì†í•˜ê¸° (Mock)</button>
      </div>
      <p class="text-xs text-gray-500">ë¡œê·¸ì¸ í›„ ì—°ë ¹ëŒ€Â·ê±°ì£¼ì§€ë¥¼ ì„¤ì •í•˜ë©´ ë³´ì • ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>
    </div>
  </div>

  <!-- í”„ë¡œí•„ / í•œêµ­ì¸ ì¸ì¦ (Mock) -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center px-4 z-[120]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 card relative">
      <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600" onclick="closeProfileModal()">x</button>
      <div class="flex items-center gap-2 mb-4">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">K</div>
        <div>
          <p class="text-sm text-gray-500">í•œêµ­ì¸ ì¸ì¦ (Mock)</p>
          <p class="font-semibold text-gray-900">ì—°ë ¹ëŒ€ Â· ê±°ì£¼ì§€ ì„¤ì •</p>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <label class="text-sm font-semibold text-gray-700">ì—°ë ¹ëŒ€</label>
          <select id="profile-age" class="mt-2 w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option>10ëŒ€</option>
            <option>20ëŒ€</option>
            <option>30ëŒ€</option>
            <option>40ëŒ€</option>
            <option>50ëŒ€</option>
            <option>60+</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">ê±°ì£¼ì§€</label>
          <select id="profile-region" class="mt-2 w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option>ì„œìš¸/ìˆ˜ë„ê¶Œ</option>
            <option>ì§€ë°©</option>
            <option>í•´ì™¸</option>
          </select>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 border border-gray-100 p-3 rounded-xl">
          <span class="material-symbols-outlined text-base text-blue-500">verified_user</span>
          ì‹¤ëª…/í†µì‹ ì‚¬ëŠ” ë¬»ì§€ ì•ŠìŠµë‹ˆë‹¤. ì—°ë ¹Â·ê±°ì£¼ì§€ë§Œ í™•ë³´í•´ ì—¬ë¡  ë³´ì •ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
        </div>
        <button onclick="saveProfile()" class="w-full py-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold shadow-md hover:shadow-lg transition">ì¸ì¦ ì •ë³´ ì €ì¥</button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
    <div class="max-w-3xl mx-auto px-4 h-14 flex items-center justify-between relative">
      <div class="flex items-center gap-2 cursor-pointer" onclick="setView('home')">
        <span class="material-symbols-outlined text-blue-600 text-2xl">how_to_vote</span>
        <div>
          <p class="text-xs text-gray-500">ëŒ€í•œë¯¼êµ­ ì§„ì§œ ì—¬ë¡ </p>
          <p class="font-semibold">ì¡°ì‘ ì—†ëŠ” MVP</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-1 text-xs text-blue-600 font-semibold bg-blue-50 px-3 py-1 rounded-full">
          <span class="w-2 h-2 rounded-full bg-blue-500 pulse-dot"></span>
          í•œêµ­ì¸ ì¸ì¦(Mock)
        </div>
        <button id="btn-open-profile" class="p-2 rounded-full hover:bg-gray-100 text-xl leading-none" aria-label="í”„ë¡œí•„ ì—´ê¸°">ğŸ‘¤</button>
      </div>

      <!-- ì‚¬ìš©ì ì •ë³´ íŒ¨ë„ -->
      <div id="user-panel" class="hidden absolute right-0 top-14 w-72 bg-white border border-gray-200 rounded-2xl shadow-xl p-4 z-[130] space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs text-gray-500" id="user-panel-provider">ë¡œê·¸ì¸ í•„ìš”</p>
            <p class="text-lg font-semibold text-gray-900" id="user-panel-name">ê²ŒìŠ¤íŠ¸</p>
            <p class="text-sm text-gray-600 mt-1" id="user-panel-profile">ì—°ë ¹Â·ê±°ì£¼ì§€ ë¯¸ì…ë ¥</p>
          </div>
          <span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700" id="user-panel-rep-tag">ëŒ€í‘œì„± ì•ˆë‚´</span>
        </div>
        <p class="text-xs text-gray-500 leading-relaxed" id="user-panel-rep-msg">ì—°ë ¹ëŒ€ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ëŒ€í‘œì„± ê¸°ì—¬ë„ë¥¼ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.</p>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="openProfileModal()" class="py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:border-blue-500 hover:text-blue-600 transition">ì—°ë ¹ëŒ€Â·ê±°ì£¼ì§€ ìˆ˜ì •</button>
          <button onclick="logout()" class="py-2 rounded-xl bg-gray-900 text-white text-sm font-semibold hover:bg-gray-800 transition">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 pt-4">
    <section id="view-home" class="page-transition">
      <h2 class="text-xl font-extrabold text-gray-800 mb-4">ì´ìŠˆ ëª©ë¡</h2>

      <!-- íˆì–´ë¡œ: ì˜¤ëŠ˜ì˜ ì´ìŠˆ + ëŒ€í‘œì„± ì¹´ë“œ -->
      <div id="hero-card" class="bg-gradient-to-r from-blue-900 via-blue-700 to-blue-500 rounded-3xl text-white p-6 card relative overflow-hidden mb-4 cursor-pointer">
        <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_top,_#60a5fa_0,_transparent_38%)]"></div>
        <div class="relative z-10 flex flex-col gap-3">
          <div class="flex items-center gap-2 text-sm text-blue-100">
            <span class="px-2 py-0.5 rounded-full bg-white/15 text-[11px] font-semibold">ì˜¤ëŠ˜ì˜ ì´ìŠˆ</span>
            <span id="home-category" class="text-blue-50">ì •ì±…</span>
          </div>
          <h1 id="home-title" class="text-2xl font-extrabold leading-snug">êµ­ë¯¼ì—°ê¸ˆ ê°œí˜ì•ˆ, ë™ì˜í•˜ì‹­ë‹ˆê¹Œ?</h1>
          <p id="home-description" class="text-sm text-blue-50">ì„¸ëŒ€ë³„ í¸í–¥ì„ ë³´ì •í•œ ì§„ì§œ ì—¬ë¡ ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
          <div class="grid grid-cols-3 gap-3 text-sm">
            <div class="bg-white/10 rounded-2xl px-3 py-2 border border-white/10">
              <p class="text-blue-100">ì´ ì°¸ì—¬</p>
              <p id="home-total" class="text-lg font-bold">0ëª…</p>
            </div>
            <div class="bg-white/10 rounded-2xl px-3 py-2 border border-white/10">
              <p class="text-blue-100">ëŒ€í‘œì„± ì ìˆ˜</p>
              <p id="home-rep-score" class="text-lg font-bold">0 / 100</p>
            </div>
            <div class="bg-white/10 rounded-2xl px-3 py-2 border border-white/10">
              <p class="text-blue-100">ë‚´ íˆ¬í‘œ</p>
              <p id="home-my-vote" class="text-lg font-bold">ëŒ€ê¸°</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 mt-1">
            <button id="btn-hero-vote" class="px-4 py-3 rounded-xl bg-white text-blue-700 font-semibold shadow-md hover:-translate-y-0.5 transition">íˆ¬í‘œí•˜ê¸°</button>
            <button id="btn-hero-view" class="px-4 py-3 rounded-xl bg-white/15 text-white font-semibold border border-white/20 hover:border-white/40 transition">í˜„ì¬ ì—¬ë¡  ë³´ê¸°</button>
          </div>
          <div class="bg-white rounded-2xl border border-blue-100 p-3 mt-2 h-28 shadow-sm">
            <p class="text-xs text-blue-600 mb-2">Raw ì—¬ë¡  ë¯¸ë¦¬ë³´ê¸°</p>
            <canvas id="preview-raw" class="h-full"></canvas>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 overflow-x-auto pb-3 mb-2 -mx-1 px-1" id="category-tabs"></div>

      <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì´ìŠˆ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
      <div id="issue-list" class="space-y-4 mb-12"></div>
    </section>

    <section id="view-detail" class="page-transition hidden">
      <button onclick="setView('home')" class="mb-4 flex items-center text-gray-500 hover:text-gray-700 transition-colors">
        <span class="material-symbols-outlined text-xl mr-1">arrow_back_ios</span>
        <span class="text-sm font-medium">ëª©ë¡ìœ¼ë¡œ</span>
      </button>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <span id="detail-category" class="px-2 py-0.5 rounded bg-gray-50 text-gray-500 text-[11px] font-bold mb-2 inline-block">ì •ì±…</span>
        <h2 id="detail-title" class="text-2xl font-bold text-gray-900 mb-4 leading-snug">êµ­ë¯¼ì—°ê¸ˆ ê°œí˜ì•ˆ, ë™ì˜í•˜ì‹­ë‹ˆê¹Œ?</h2>

        <div id="vote-area" class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-700">ë‹¹ì‹ ì˜ ì˜ê²¬ì€ ë¬´ì—‡ì¸ê°€ìš”?</h3>
            <span class="text-xs text-gray-400 font-medium">1ì¸ 1í‘œ, ìˆ˜ì • ë¶ˆê°€</span>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <button id="vote-agree" onclick="handleVote('agree')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-blue-500 hover:bg-blue-50 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">ì°¬ì„±</button>
            <button id="vote-neutral" onclick="handleVote('neutral')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-gray-400 hover:bg-gray-100 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">ì¤‘ë¦½</button>
            <button id="vote-disagree" onclick="handleVote('disagree')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-red-500 hover:bg-red-50 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">ë°˜ëŒ€</button>
          </div>
        </div>

        <div id="result-area" class="border-t border-gray-100 pt-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600 text-xl">insights</span>
            ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼ (ì „ì²´)
          </h3>
          <div id="total-vote-count" class="text-sm text-gray-500 mb-3 font-medium">ì´ 0ëª… ì°¸ì—¬</div>

          <div class="w-full h-8 bg-gray-100 rounded-full flex overflow-hidden mb-2">
            <div id="bar-agree" style="width: 0%" class="h-full bg-blue-600 bar-fill flex items-center justify-center text-[10px] text-white font-bold px-1"></div>
            <div id="bar-neutral" style="width: 0%" class="h-full bg-gray-400 bar-fill flex items-center justify-center text-[10px] text-gray-800 font-bold px-1"></div>
            <div id="bar-disagree" style="width: 0%" class="h-full bg-red-600 bar-fill flex items-center justify-center text-[10px] text-white font-bold px-1"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 font-medium px-1">
            <span id="percent-agree" class="text-blue-600">ì°¬ì„± 0%</span>
            <span id="percent-neutral" class="text-gray-600">ì¤‘ë¦½ 0%</span>
            <span id="percent-disagree" class="text-red-600">ë°˜ëŒ€ 0%</span>
          </div>
        </div>
      </div>

      <!-- ì—¬ë¡  ë¶„ì„ ì„¹ì…˜ -->
      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <div>
            <p class="text-xs text-gray-500">ë³´ì • + í¸í–¥ ê²½ê³ </p>
            <h3 class="text-xl font-bold text-gray-900">ì—¬ë¡  ë¶„ì„ (Raw vs ë³´ì •)</h3>
            <p class="text-sm text-gray-600 mt-1">ì „ì²´ ì—¬ë¡ (%)ê³¼ ë³´ì • ì—¬ë¡ (%)ì„ ë‚˜ë€íˆ ë¹„êµí•©ë‹ˆë‹¤. xì¶•ì€ 0~100% (20% ê°„ê²©) ì…ë‹ˆë‹¤.</p>
          </div>
          <div class="flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-emerald-50 text-emerald-700 font-semibold">
            <span class="material-symbols-outlined text-base">verified</span>
            <span>ëŒ€í‘œì„± <span id="detail-rep-score">0</span>/100</span>
          </div>
        </div>
        <div id="bias-warnings" class="space-y-2 mb-4"></div>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-xs text-gray-500">Raw</p>
                <p class="font-bold">ì „ì²´ ì—¬ë¡ </p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-gray-700">ê°€ë¡œ ìŠ¤íƒ</span>
            </div>
            <div class="h-40"><canvas id="chart-raw"></canvas></div>
          </div>
          <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-xs text-gray-500">ë³´ì •</p>
                <p class="font-bold">ëŒ€í•œë¯¼êµ­ ì¸êµ¬ ê°€ì¤‘ì¹˜ ì ìš©</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">ê°€ì¤‘ ìŠ¤íƒ</span>
            </div>
            <div class="h-40"><canvas id="chart-corrected"></canvas></div>
          </div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs text-gray-500">ì—°ë ¹ë³„</p>
              <p class="font-bold">ì—°ë ¹ëŒ€ë³„ ì°¬Â·ì¤‘Â·ë°˜ ë¶„í¬</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">stacked bar</span>
          </div>
          <div class="h-72"><canvas id="chart-age"></canvas></div>
        </div>
      </div>

      <!-- ì™¸ë¶€ ì—¬ë¡  ë ˆì´ë” -->
      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div>
            <p class="text-xs text-gray-500">SNS Â· ì»¤ë®¤ë‹ˆí‹° ìš”ì•½</p>
            <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
              <span class="material-symbols-outlined text-indigo-600 text-xl">travel_explore</span>
              ì™¸ë¶€ ì—¬ë¡  ë ˆì´ë” (SNS Â· ì»¤ë®¤ë‹ˆí‹°)
            </h3>
            <p class="text-sm text-gray-600 mt-1">snsì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ì—¬ë¡ ê³¼ í”Œë«í¼ ì—¬ë¡ ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>
          </div>
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">AI ë¶„ì„ Mock</span>
        </div>
        <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4 mb-4">
          <div class="flex items-center justify-between mb-2 text-sm text-gray-700">
            <span class="font-semibold">í”Œë«í¼ ì—¬ë¡  vs SNS ì—¬ë¡ </span>
            <span id="external-sample" class="text-xs text-gray-500"></span>
          </div>
          <div class="h-40"><canvas id="chart-external"></canvas></div>
          <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
            <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">í”Œë«í¼</span>
            <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">SNS</span>
          </div>
        </div>
        <div id="external-narratives" class="space-y-3"></div>
      </div>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-xl text-indigo-600">menu_book</span>
          ì´ìŠˆ ê·¼ê±° ìë£Œ (Evidence)
        </h3>
        <div class="flex border-b border-gray-200 mb-4">
          <button id="tab-pro" onclick="selectEvidenceTab('pro', this)" class="tab-btn pb-2 px-4 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600 hover:text-indigo-700 transition-colors">ì°¬ì„± ê·¼ê±° (Pro)</button>
          <button id="tab-con" onclick="selectEvidenceTab('con', this)" class="tab-btn pb-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">ë°˜ëŒ€ ê·¼ê±° (Con)</button>
        </div>
        <div id="evidence-list" class="space-y-4"></div>
      </div>

      <div class="mb-20">
        <div class="flex justify-between items-end mb-4">
          <h3 class="text-lg font-bold text-gray-900">ìµœë‹¤ ê³µê° ì˜ê²¬ (<span id="comment-count">0</span>)</h3>
          <button onclick="addCommentFromPrompt()" class="text-sm text-blue-600 font-semibold hover:text-blue-800 transition-colors">ì„ì‹œ ì˜ê²¬ ì¶”ê°€</button>
        </div>
        <div id="comment-list" class="space-y-3"></div>
      </div>
    </section>
  </main>

  <script>
    const ISSUE_CATEGORIES = ['ì „ì²´', 'ì •ì¹˜', 'ì‚¬íšŒ', 'ê²½ì œ', 'ê¸°íƒ€'];

    const ISSUES = [
      { id: 'issue-1', category: 'ì •ì¹˜', title: 'êµ­ë¯¼ì—°ê¸ˆ ê°œí˜ì•ˆ, ë™ì˜í•˜ì‹­ë‹ˆê¹Œ?', description: 'ë³´í—˜ë£Œìœ¨ ì¸ìƒÂ·ì—°ê¸ˆ ì§€ê¸‰ ê°œí¸ í¬í•¨. ì„¸ëŒ€ë³„ ì´í•´ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.', isHot: true },
      { id: 'issue-2', category: 'ì‚¬íšŒ', title: 'ìˆ˜ë„ê¶Œ ì‹¬ì•¼ ëŒ€ì¤‘êµí†µ í™•ëŒ€, ì°¬ì„±í•˜ì‹­ë‹ˆê¹Œ?', description: 'ë§‰ì°¨ ì—°ì¥Â·ì‹¬ì•¼ ë²„ìŠ¤ ì¦í¸ ë¹„ìš©ì„ ê°ë‹¹í• ì§€ ì˜ê²¬ì„ ë¬»ìŠµë‹ˆë‹¤.', isHot: false },
      { id: 'issue-3', category: 'ê²½ì œ', title: 'ì „ê¸°ìš”ê¸ˆ ì—°ë™ì œ ì¬ë„ì…ì´ í•„ìš”í• ê¹Œìš”?', description: 'êµ­ì œ ì—ë„ˆì§€ ê°€ê²© ë³€ë™ì„ ë°˜ì˜í•˜ëŠ” ìš”ê¸ˆì œì— ëŒ€í•œ ì§ˆë¬¸ì…ë‹ˆë‹¤.', isHot: false },
      { id: 'issue-4', category: 'ê¸°íƒ€', title: 'ì‹¤ëª…ì œ ì†Œì…œë¯¸ë””ì–´ ë„ì…, ì–´ë–»ê²Œ ìƒê°í•˜ë‚˜ìš”?', description: 'ì•…ì„± ê²Œì‹œë¬¼ ê°ì†Œ vs í‘œí˜„ì˜ ììœ  ì¹¨í•´ ìš°ë ¤ë¥¼ ë¬»ìŠµë‹ˆë‹¤.', isHot: false }
    ];

    const AGE_GROUPS = [
      { id: '10ëŒ€', label: '10ëŒ€', populationRatio: 0.09 },
      { id: '20ëŒ€', label: '20ëŒ€', populationRatio: 0.14 },
      { id: '30ëŒ€', label: '30ëŒ€', populationRatio: 0.16 },
      { id: '40ëŒ€', label: '40ëŒ€', populationRatio: 0.18 },
      { id: '50ëŒ€', label: '50ëŒ€', populationRatio: 0.19 },
      { id: '60+', label: '60+', populationRatio: 0.24 }
    ];

    const EVIDENCE = {
      'issue-1': {
        pro: [
          { title: 'ë³´í—˜ë£Œìœ¨ ìƒí–¥ìœ¼ë¡œ ê¸°ê¸ˆ ê³ ê°ˆ ì‹œì  ì—°ê¸°', source: 'êµ­íšŒ ì˜ˆì‚°ì •ì±…ì²˜', link: '#' },
          { title: 'ì²­ë…„ì¸µ ë¶€ë‹´ ì™„í™” ìœ„í•œ ë‹¨ê³„ì  ê°œí¸ í•„ìš”', source: 'ì—°ê¸ˆì—°êµ¬ì› ë¸Œë¦¬í”„', link: '#' }
        ],
        con: [
          { title: 'ë³´í—˜ë£Œ ì¸ìƒì€ ì €ì†Œë“ì¸µ ì—­ì§„ì„± ìš°ë ¤', source: 'ì‹œë¯¼ë‹¨ì²´ ì„±ëª…', link: '#' },
          { title: 'ê¸‰ì—¬ ì¶•ì†Œ ì‹œ ë…¸í›„ì†Œë“ ë³´ì¥ ì•½í™”', source: 'í•™íšŒ í† ë¡ íšŒ', link: '#' }
        ]
      },
      'issue-2': {
        pro: [
          { title: 'ì‹¬ì•¼ ì´ë™ê¶Œ ë³´ì¥ì„ ìœ„í•œ ëŒ€ì¤‘êµí†µ í™•ëŒ€ í•„ìš”', source: 'ì„œìš¸ì—°êµ¬ì›', link: '#' },
          { title: 'íƒì‹œ ìˆ˜ê¸‰ ë¶ˆê· í˜• ì™„í™”ë¥¼ ìœ„í•´ ì‹¬ì•¼ë²„ìŠ¤ ì¦í¸', source: 'êµí†µ ì •ì±… í¬ëŸ¼', link: '#' }
        ],
        con: [
          { title: 'ì‹¬ì•¼ ë…¸ì„  í™•ëŒ€ ì‹œ ì ì ë¶€ë‹´ ìš°ë ¤', source: 'ì§€ìì²´ ì˜ˆì‚° ë³´ê³ ì„œ', link: '#' },
          { title: 'ì•ˆì „ ì¸ë ¥ í™•ë³´ ì—†ì´ ì—°ì¥ì€ ìœ„í—˜', source: 'ë…¸ë™ì¡°í•© ì„±ëª…', link: '#' }
        ]
      },
      'issue-3': {
        pro: [
          { title: 'ì—°ë™ì œëŠ” ì—ë„ˆì§€ ì ˆì•½ì„ ìœ ë„í•´ ì†Œë¹„ë¥¼ ì¤„ì¸ë‹¤', source: 'ì—ë„ˆì§€ê²½ì œì—°êµ¬ì›', link: '#' },
          { title: 'êµ­ì œ ê°€ê²© ê¸‰ë“± ì‹œ ì¬ì • ë¶€ë‹´ì„ ë¶„ì‚°', source: 'ì‚°ì—…ë¶€ ë¸Œë¦¬í•‘', link: '#' }
        ],
        con: [
          { title: 'ìš”ê¸ˆ ë³€ë™ì„± í™•ëŒ€ëŠ” ê°€ê³„ ë¶ˆì•ˆì„ í‚¤ìš´ë‹¤', source: 'ì†Œë¹„ìì—°ë§¹', link: '#' },
          { title: 'ì‚°ì—… ê²½ìŸë ¥ ì €í•˜ ìš°ë ¤', source: 'ë¬´ì—­í˜‘íšŒ ì½”ë©˜íŠ¸', link: '#' }
        ]
      },
      'issue-4': {
        pro: [
          { title: 'ì‹¤ëª…ì œ ë„ì… ì‹œ í—ˆìœ„Â·ì•…ì„± ê²Œì‹œë¬¼ ê°ì†Œ ê°€ëŠ¥', source: 'ì¸í„°ë„·ìœ¤ë¦¬í¬ëŸ¼', link: '#' },
          { title: 'ì‚¬ì´ë²„ í­ë ¥ í”¼í•´ì ë³´í˜¸', source: 'í”¼í•´ì ì§€ì› ë‹¨ì²´', link: '#' }
        ],
        con: [
          { title: 'ìµëª…ì„± ì œí•œì€ í‘œí˜„ì˜ ììœ  ì¹¨í•´', source: 'ë””ì§€í„¸ì¸ê¶Œ NGO', link: '#' },
          { title: 'ê°œì¸ì •ë³´ ìœ ì¶œ ë¦¬ìŠ¤í¬ ì¦ê°€', source: 'ë³´ì•ˆ ì»¨í¼ëŸ°ìŠ¤', link: '#' }
        ]
      }
    };

    const COMMENTS = {
      'issue-1': [
        { type: 'ì°¬ì„±', nickname: 'ì—°ê¸ˆê±±ì •ì—†ê²Œ', meta: '30ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ì§€ê¸ˆ ì† ì•ˆ ëŒ€ë©´ ìš°ë¦¬ ì„¸ëŒ€ê°€ ë‹¤ ë¶€ë‹´í•©ë‹ˆë‹¤.', likes: 22 },
        { type: 'ë°˜ëŒ€', nickname: 'ì€í‡´ì¤€ë¹„ì¤‘', meta: '60+ Â· ì§€ë°©', content: 'ê¸‰ì—¬ ì¤„ì´ê³  ë³´í—˜ë£Œ ì˜¬ë¦¬ë©´ ì´ì¤‘ê³ ì…ë‹ˆë‹¤.', likes: 15 },
        { type: 'ì¤‘ë¦½', nickname: 'ë°¸ëŸ°ìŠ¤ëŸ¬ë²„', meta: '20ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ì¸ìƒ í­ì„ ì„¸ë¶„í™”í•´ì„œ ì„¸ëŒ€ë³„ ì°¨ë“±ì´ í•„ìš”í•´ìš”.', likes: 11 }
      ],
      'issue-2': [
        { type: 'ì°¬ì„±', nickname: 'ì•¼ê·¼íƒˆì¶œ', meta: '20ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ì‹¬ì•¼ ì´ë™ê¶Œ í™•ë³´ê°€ ìµœìš°ì„ ì…ë‹ˆë‹¤.', likes: 14 },
        { type: 'ë°˜ëŒ€', nickname: 'ì˜ˆì‚°ìˆ˜í˜¸', meta: '40ëŒ€ Â· ì§€ë°©', content: 'ì ì ë³´ì „ì€ ê²°êµ­ ì‹œë¯¼ ë¶€ë‹´ì…ë‹ˆë‹¤.', likes: 9 }
      ],
      'issue-3': [
        { type: 'ë°˜ëŒ€', nickname: 'ì „ê¸°ì„¸ê±±ì •', meta: '30ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ìš”ê¸ˆ ì¶œë ì´ë©´ ê°€ê³„ ê³„íš ì„¸ìš°ê¸° í˜ë“¤ì–´ìš”.', likes: 7 },
        { type: 'ì°¬ì„±', nickname: 'ì—ë„ˆì§€ì ˆì•½', meta: '50ëŒ€ Â· ì§€ë°©', content: 'ì ˆì•½ì„ ìœ ë„í•˜ë ¤ë©´ ê°€ê²© ì‹ í˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.', likes: 12 }
      ],
      'issue-4': [
        { type: 'ë°˜ëŒ€', nickname: 'ìµëª…ì†Œì¤‘', meta: '20ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ìµëª…ì„±ì€ í‘œí˜„ì˜ ë‹¤ì–‘ì„±ì„ ì§€í‚¤ëŠ” ì¥ì¹˜ì…ë‹ˆë‹¤.', likes: 8 },
        { type: 'ì°¬ì„±', nickname: 'í´ë¦°ì›¹', meta: '40ëŒ€ Â· ìˆ˜ë„ê¶Œ', content: 'ì‹¤ëª…ì œë©´ ì•…í”Œì´ í™• ì¤„ ê²ƒ ê°™ì•„ìš”.', likes: 10 }
      ]
    };

    const EXTERNAL_OPINIONS = {
      'issue-1': {
        sampleSize: 1240,
        snsRatio: { ì°¬ì„±: 62, ì¤‘ë¦½: 8, ë°˜ëŒ€: 30 },
        narratives: [
          { id: 'n1', stance: 'ì°¬ì„±', title: 'ì§€ê¸ˆ ê°œí˜í•˜ì§€ ì•Šìœ¼ë©´ ì²­ë…„ ì„¸ëŒ€ê°€ ëª¨ë“  ë¶€ë‹´ì„ ì§„ë‹¤', summary: 'íŠ¸ìœ„í„°ì—ì„œ ì£¼ë¡œ 2030 ì‚¬ìš©ìë“¤ì´ ê³µìœ í•˜ëŠ” í”„ë ˆì„ì…ë‹ˆë‹¤.', isAnomaly: false },
          { id: 'n2', stance: 'ë°˜ëŒ€', title: 'ë³´í—˜ë£Œë§Œ ì˜¬ë¦¬ê³  ê¸‰ì—¬ëŠ” ê¹ì´ëŠ” ê°œì•…ì´ë‹¤', summary: 'íŠ¹ì • ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ë¬¸ì¥ì…ë‹ˆë‹¤.', isAnomaly: true },
          { id: 'n3', stance: 'ì¤‘ë¦½', title: 'ì¬ì • ê±´ì „ì„±ê³¼ ì„¸ëŒ€ í˜•í‰ì„ í•¨ê»˜ ë…¼ì˜í•´ì•¼ í•œë‹¤', summary: 'ì–¸ë¡  ê¸°íš ê¸°ì‚¬ì—ì„œ ê· í˜• ìˆê²Œ ì–¸ê¸‰ë©ë‹ˆë‹¤.', isAnomaly: false }
        ]
      },
      'issue-2': {
        sampleSize: 820,
        snsRatio: { ì°¬ì„±: 54, ì¤‘ë¦½: 18, ë°˜ëŒ€: 28 },
        narratives: [
          { id: 'n1', stance: 'ì°¬ì„±', title: 'ì‹¬ì•¼ ì´ë™ê¶Œ í™•ë³´ê°€ ë¨¼ì €ë‹¤', summary: 'ì•¼ê·¼/ì•Œë°” ì¢…ì‚¬ìë“¤ì´ ì§€ì§€í•˜ëŠ” ì˜ê²¬ì…ë‹ˆë‹¤.', isAnomaly: false },
          { id: 'n2', stance: 'ë°˜ëŒ€', title: 'ì˜ˆì‚°ë§Œ ìƒˆê³  ì´ìš©ìëŠ” ì ë‹¤', summary: 'ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ë°˜ë³µë˜ëŠ” ë¹„ìš© ìš°ë ¤ í”„ë ˆì„ì…ë‹ˆë‹¤.', isAnomaly: false }
        ]
      },
      'issue-3': {
        sampleSize: 960,
        snsRatio: { ì°¬ì„±: 35, ì¤‘ë¦½: 25, ë°˜ëŒ€: 40 },
        narratives: [
          { id: 'n1', stance: 'ë°˜ëŒ€', title: 'ìš”ê¸ˆ ë³€ë™ì„±ì€ ê°€ê³„ ë¶ˆì•ˆì„ í‚¤ìš´ë‹¤', summary: 'ì†Œë¹„ì ì»¤ë®¤ë‹ˆí‹° ì¤‘ì‹¬ìœ¼ë¡œ í™•ì‚°ëœ ì£¼ì¥ì…ë‹ˆë‹¤.', isAnomaly: false },
          { id: 'n2', stance: 'ì°¬ì„±', title: 'ê°€ê²© ì‹ í˜¸ê°€ ìˆì–´ì•¼ ì ˆì•½ì´ ê°€ëŠ¥í•˜ë‹¤', summary: 'ì—ë„ˆì§€ ì ˆì•½ ìº í˜ì¸ì—ì„œ ìì£¼ ì–¸ê¸‰ë©ë‹ˆë‹¤.', isAnomaly: false }
        ]
      },
      'issue-4': {
        sampleSize: 710,
        snsRatio: { ì°¬ì„±: 41, ì¤‘ë¦½: 17, ë°˜ëŒ€: 42 },
        narratives: [
          { id: 'n1', stance: 'ë°˜ëŒ€', title: 'ì‹¤ëª…ì œëŠ” í‘œí˜„ì˜ ììœ ë¥¼ í›¼ì†í•œë‹¤', summary: 'ë””ì§€í„¸ ì¸ê¶Œ ë‹¨ì²´ê°€ ê°•ì¡°í•˜ëŠ” ë©”ì‹œì§€ì…ë‹ˆë‹¤.', isAnomaly: false },
          { id: 'n2', stance: 'ì°¬ì„±', title: 'ì‹¤ëª…ì œë©´ ì•…ì„± ê²Œì‹œë¬¼ì´ í™• ì¤„ ê²ƒ', summary: 'ì»¤ë®¤ë‹ˆí‹° ë‚´ í”¼í•´ ì‚¬ë¡€ ê³µìœ  ê¸€ì—ì„œ ì£¼ë¡œ ë“±ì¥í•©ë‹ˆë‹¤.', isAnomaly: true }
        ]
      }
    };

    const NARRATIVE_COMMENTS = {};

    const STORAGE_KEYS = {
      profile: 'rr-profile',
      votes: 'rr-votes',
      userVote: 'rr-user-vote-map',
      user: 'rr-user'
    };

    const COLORS = {
      ì°¬ì„±: 'rgb(37, 99, 235)',
      ì¤‘ë¦½: 'rgb(107, 114, 128)',
      ë°˜ëŒ€: 'rgb(239, 68, 68)'
    };

    const charts = { raw: null, corrected: null, age: null, preview: null, external: null };

    let votes = [];
    let userProfile = null;
    let userVoteMap = {};
    let currentUser = null;
    let selectedIssueId = null;
    let activeEvidenceTab = 'pro';
    let activeCategory = 'ì „ì²´';
    let latestMetricsMap = {};

    const SEED_VOTES = [
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '20ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 90000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '30ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 88000 },
      { issueId: 'issue-1', choice: 'ë°˜ëŒ€', age_group: '40ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 86000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '40ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 84000 },
      { issueId: 'issue-1', choice: 'ì¤‘ë¦½', age_group: '50ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 82000 },
      { issueId: 'issue-1', choice: 'ë°˜ëŒ€', age_group: '60+', region: 'ì§€ë°©', timestamp: Date.now() - 80000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '50ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 78000 },
      { issueId: 'issue-1', choice: 'ì¤‘ë¦½', age_group: '30ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 76000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '20ëŒ€', region: 'í•´ì™¸', timestamp: Date.now() - 74000 },
      { issueId: 'issue-1', choice: 'ë°˜ëŒ€', age_group: '60+', region: 'ì§€ë°©', timestamp: Date.now() - 72000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '40ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 70000 },
      { issueId: 'issue-1', choice: 'ì¤‘ë¦½', age_group: '10ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 68000 },
      { issueId: 'issue-1', choice: 'ë°˜ëŒ€', age_group: '50ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 66000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '30ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 64000 },
      { issueId: 'issue-1', choice: 'ì¤‘ë¦½', age_group: '40ëŒ€', region: 'í•´ì™¸', timestamp: Date.now() - 62000 },
      { issueId: 'issue-1', choice: 'ì°¬ì„±', age_group: '50ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 60000 },
      { issueId: 'issue-1', choice: 'ë°˜ëŒ€', age_group: '20ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 58000 },
      { issueId: 'issue-1', choice: 'ì¤‘ë¦½', age_group: '60+', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 56000 },
      { issueId: 'issue-2', choice: 'ì°¬ì„±', age_group: '20ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 54000 },
      { issueId: 'issue-2', choice: 'ì°¬ì„±', age_group: '30ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 52000 },
      { issueId: 'issue-2', choice: 'ì¤‘ë¦½', age_group: '40ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 50000 },
      { issueId: 'issue-2', choice: 'ë°˜ëŒ€', age_group: '50ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 48000 },
      { issueId: 'issue-2', choice: 'ì°¬ì„±', age_group: '20ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 46000 },
      { issueId: 'issue-2', choice: 'ë°˜ëŒ€', age_group: '60+', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 44000 },
      { issueId: 'issue-3', choice: 'ì°¬ì„±', age_group: '50ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 42000 },
      { issueId: 'issue-3', choice: 'ë°˜ëŒ€', age_group: '30ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 40000 },
      { issueId: 'issue-3', choice: 'ì¤‘ë¦½', age_group: '40ëŒ€', region: 'í•´ì™¸', timestamp: Date.now() - 38000 },
      { issueId: 'issue-3', choice: 'ì°¬ì„±', age_group: '20ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 36000 },
      { issueId: 'issue-3', choice: 'ë°˜ëŒ€', age_group: '60+', region: 'ì§€ë°©', timestamp: Date.now() - 34000 },
      { issueId: 'issue-4', choice: 'ë°˜ëŒ€', age_group: '20ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 32000 },
      { issueId: 'issue-4', choice: 'ì°¬ì„±', age_group: '40ëŒ€', region: 'ì„œìš¸/ìˆ˜ë„ê¶Œ', timestamp: Date.now() - 30000 },
      { issueId: 'issue-4', choice: 'ì¤‘ë¦½', age_group: '30ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 28000 },
      { issueId: 'issue-4', choice: 'ë°˜ëŒ€', age_group: '50ëŒ€', region: 'ì§€ë°©', timestamp: Date.now() - 26000 }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      votes = loadJSON(STORAGE_KEYS.votes, []);
      if (!votes.length) {
        votes = [...SEED_VOTES];
        saveJSON(STORAGE_KEYS.votes, votes);
      }
      userProfile = loadJSON(STORAGE_KEYS.profile, null);
      userVoteMap = loadJSON(STORAGE_KEYS.userVote, {});
      currentUser = loadJSON(STORAGE_KEYS.user, null);
      selectedIssueId = loadJSON('rr-selected-issue', null) || getHotIssue().id;

      bindBaseEvents();
      renderAll();

      if (!currentUser) openLoginModal();
      else if (!userProfile) showToast('ì—°ë ¹ëŒ€Â·ê±°ì£¼ì§€ë¥¼ ì„¤ì •í•˜ë©´ ë³´ì • ì •í™•ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.', 'info');
    });

    function bindBaseEvents() {
      document.getElementById('login-kakao').addEventListener('click', () => mockLogin('kakao'));
      document.getElementById('login-naver').addEventListener('click', () => mockLogin('naver'));
      document.getElementById('login-google').addEventListener('click', () => mockLogin('google'));
      document.getElementById('login-email').addEventListener('click', () => mockLogin('email'));
      document.getElementById('btn-open-profile').addEventListener('click', toggleUserPanel);

      const heroCard = document.getElementById('hero-card');
      heroCard?.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        openDetail(getHotIssue().id);
      });
      document.getElementById('btn-hero-vote').addEventListener('click', (e) => { e.stopPropagation(); openDetail(getHotIssue().id); });
      document.getElementById('btn-hero-view').addEventListener('click', (e) => { e.stopPropagation(); openDetail(getHotIssue().id); });

      document.addEventListener('click', (e) => {
        const panel = document.getElementById('user-panel');
        const trigger = document.getElementById('btn-open-profile');
        if (!panel || panel.classList.contains('hidden')) return;
        if (panel.contains(e.target) || trigger.contains(e.target)) return;
        closeUserPanel();
      });
    }

    function openLoginModal() {
      const modal = document.getElementById('login-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeLoginModal() {
      const modal = document.getElementById('login-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function providerLabel(provider) {
      const map = { kakao: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸', naver: 'ë„¤ì´ë²„ ë¡œê·¸ì¸', google: 'êµ¬ê¸€ ë¡œê·¸ì¸', email: 'ì´ë©”ì¼ ë¡œê·¸ì¸' };
      return map[provider] || 'Mock ë¡œê·¸ì¸';
    }

    function mockLogin(provider) {
      currentUser = { id: `demo-${provider}-${Date.now()}`, name: 'í…ŒìŠ¤íŠ¸ ìœ ì €', provider, createdAt: Date.now() };
      saveJSON(STORAGE_KEYS.user, currentUser);
      showToast(`${providerLabel(provider)} ì™„ë£Œ (Mock)`, 'success');
      closeLoginModal();
      closeUserPanel();
      renderUserPanel();
      if (!userProfile) setTimeout(() => openProfileModal(), 200);
    }

    function logout() {
      localStorage.removeItem(STORAGE_KEYS.user);
      localStorage.removeItem(STORAGE_KEYS.profile);
      localStorage.removeItem(STORAGE_KEYS.userVote);
      localStorage.removeItem(STORAGE_KEYS.votes);
      currentUser = null;
      userProfile = null;
      userVoteMap = {};
      votes = [...SEED_VOTES];
      selectedIssueId = getHotIssue().id;
      latestMetricsMap = {};
      renderAll();
      openLoginModal();
      showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    function toggleUserPanel() {
      if (!ensureLoggedIn()) return;
      renderUserPanel();
      document.getElementById('user-panel').classList.toggle('hidden');
    }

    function closeUserPanel() {
      const panel = document.getElementById('user-panel');
      panel?.classList.add('hidden');
    }

    function renderUserPanel() {
      const panel = document.getElementById('user-panel');
      if (!panel) return;
      if (!currentUser) {
        panel.classList.add('hidden');
        return;
      }
      document.getElementById('user-panel-name').innerText = currentUser.name || 'Mock ìœ ì €';
      document.getElementById('user-panel-provider').innerText = providerLabel(currentUser.provider);
      document.getElementById('user-panel-profile').innerText = userProfile ? `${userProfile.ageGroup} Â· ${userProfile.region}` : 'ì—°ë ¹Â·ê±°ì£¼ì§€ ë¯¸ì…ë ¥';
      const issueId = getSelectedIssue().id;
      document.getElementById('user-panel-rep-msg').innerText = getRepresentationHint(issueId);
      document.getElementById('user-panel-rep-tag').innerText = `ëŒ€í‘œì„± ${latestMetricsMap[issueId]?.repScore ?? 0}/100`;
    }

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function ensureLoggedIn() {
      if (!currentUser) {
        showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'error');
        openLoginModal();
        return false;
      }
      return true;
    }

    function ensureProfile() {
      if (!ensureLoggedIn()) return false;
      if (!userProfile || !userProfile.ageGroup || !userProfile.region) {
        showToast('ì—°ë ¹ëŒ€ì™€ ê±°ì£¼ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš” (Mock ì¸ì¦)', 'error');
        openProfileModal();
        return false;
      }
      return true;
    }

    function openProfileModal() {
      if (!ensureLoggedIn()) return;
      document.getElementById('profile-age').value = userProfile?.ageGroup || '';
      document.getElementById('profile-region').value = userProfile?.region || '';
      document.getElementById('profile-modal').classList.remove('hidden');
      document.getElementById('profile-modal').classList.add('flex');
    }

    function closeProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function saveProfile() {
      if (!ensureLoggedIn()) return;
      const ageGroup = document.getElementById('profile-age').value;
      const region = document.getElementById('profile-region').value;
      if (!ageGroup || !region) {
        showToast('ì—°ë ¹ëŒ€ì™€ ê±°ì£¼ì§€ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      userProfile = { ageGroup, region, verifiedKorean: true };
      saveJSON(STORAGE_KEYS.profile, userProfile);
      showToast('ì¸ì¦ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      closeProfileModal();
      renderAll();
    }

    function setView(view) {
      ['home', 'detail'].forEach((name) => {
        const el = document.getElementById(`view-${name}`);
        el.classList.add('hidden');
        el.classList.remove('fade-enter-active');
      });
      const target = document.getElementById(`view-${view}`);
      if (!target) return;
      target.classList.remove('hidden');
      target.classList.add('fade-enter');
      setTimeout(() => {
        target.classList.add('fade-enter-active');
        target.classList.remove('fade-enter');
      }, 10);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      closeUserPanel();
    }

    function setSelectedIssue(issueId) {
      selectedIssueId = issueId;
      saveJSON('rr-selected-issue', issueId);
      activeEvidenceTab = 'pro';
    }

    function getHotIssue() {
      return ISSUES.find((i) => i.isHot) || ISSUES[0];
    }

    function getSelectedIssue() {
      return ISSUES.find((i) => i.id === selectedIssueId) || getHotIssue();
    }

    function renderAll() {
      latestMetricsMap = buildIssueMetricsMap();
      renderUserPanel();
      renderHome(latestMetricsMap);
      renderDetail(latestMetricsMap);
    }

    function buildIssueMetricsMap() {
      const map = {};
      ISSUES.forEach((issue) => {
        map[issue.id] = buildIssueMetrics(issue.id);
      });
      return map;
    }

    function buildIssueMetrics(issueId) {
      const issueVotes = votes.filter((v) => v.issueId === issueId);
      const raw = computeRaw(issueVotes);
      const ageStats = computeAgeStats(issueVotes);
      const corrected = computeCorrected(ageStats, raw.total);
      const repScore = computeRepresentationScore(ageStats, raw.total);
      const warnings = buildWarnings(ageStats, raw.total);
      return { raw, ageStats, corrected, repScore, warnings };
    }

    function computeRaw(issueVotes) {
      const counts = { ì°¬ì„±: 0, ì¤‘ë¦½: 0, ë°˜ëŒ€: 0 };
      issueVotes.forEach((v) => { if (counts[v.choice] !== undefined) counts[v.choice] += 1; });
      const total = Object.values(counts).reduce((a, b) => a + b, 0);
      const percents = {};
      Object.entries(counts).forEach(([k, v]) => { percents[k] = total ? Math.round((v / total) * 1000) / 10 : 0; });
      return { counts, percents, total };
    }

    function computeAgeStats(issueVotes) {
      const stats = {};
      AGE_GROUPS.forEach((g) => { stats[g.id] = { total: 0, counts: { ì°¬ì„±: 0, ì¤‘ë¦½: 0, ë°˜ëŒ€: 0 } }; });
      issueVotes.forEach((v) => {
        if (!stats[v.age_group]) return;
        stats[v.age_group].total += 1;
        stats[v.age_group].counts[v.choice] = (stats[v.age_group].counts[v.choice] || 0) + 1;
      });
      return stats;
    }

    function computeCorrected(ageStats, total) {
      const corrected = { ì°¬ì„±: 0, ì¤‘ë¦½: 0, ë°˜ëŒ€: 0 };
      if (!total) return corrected;
      AGE_GROUPS.forEach((group) => {
        const stat = ageStats[group.id];
        if (!stat || !stat.total) return;
        const sampleRatio = stat.total / total;
        const weight = group.populationRatio / sampleRatio;
        ['ì°¬ì„±', 'ì¤‘ë¦½', 'ë°˜ëŒ€'].forEach((choice) => {
          const share = stat.counts[choice] / stat.total;
          corrected[choice] += share * weight;
        });
      });
      const sum = corrected.ì°¬ì„± + corrected.ì¤‘ë¦½ + corrected.ë°˜ëŒ€;
      if (!sum) return corrected;
      Object.keys(corrected).forEach((k) => { corrected[k] = Math.round((corrected[k] / sum) * 1000) / 10; });
      return corrected;
    }

    function computeRepresentationScore(ageStats, total) {
      if (!total) return 0;
      let deviation = 0;
      AGE_GROUPS.forEach((group) => {
        const sampleRatio = total ? (ageStats[group.id]?.total || 0) / total : 0;
        deviation += Math.abs(sampleRatio - group.populationRatio);
      });
      const normalized = Math.max(0, 1 - Math.min(1, deviation * 1.2));
      return Math.round(normalized * 100);
    }

    function buildWarnings(ageStats, total) {
      const warnings = [];
      AGE_GROUPS.forEach((group) => {
        const sample = ageStats[group.id]?.total || 0;
        const sampleRatio = total ? sample / total : 0;
        const popRatio = group.populationRatio;
        if (!sample) {
          warnings.push(`${group.label} ì°¸ì—¬ê°€ ì—†ì–´ ê²°ê³¼ê°€ ì™œê³¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          return;
        }
        const factor = sampleRatio / popRatio;
        if (factor >= 1.4) warnings.push(`${group.label} ì°¸ì—¬ìœ¨ì´ ì‹¤ì œ ì¸êµ¬ë³´ë‹¤ ${factor.toFixed(1)}ë°° ë†’ìŠµë‹ˆë‹¤.`);
        if (factor <= 0.6) warnings.push(`${group.label} ì°¸ì—¬ìœ¨ì´ ë‚®ì•„ ë³´ì •ì´ í¬ê²Œ ì ìš©ë©ë‹ˆë‹¤.`);
      });
      if (!warnings.length) warnings.push('ì—°ë ¹ëŒ€ ë¹„ì¤‘ì´ ë¹„êµì  ê· í˜•ì ì…ë‹ˆë‹¤. (ê°€ì¤‘ì¹˜ ì ìš© í›„)');
      return warnings;
    }

    function renderHome(metricsMap) {
      const hotIssue = getHotIssue();
      const metrics = metricsMap[hotIssue.id] || buildIssueMetrics(hotIssue.id);
      document.getElementById('home-category').innerText = hotIssue.category;
      document.getElementById('home-title').innerText = hotIssue.title;
      document.getElementById('home-description').innerText = hotIssue.description;
      document.getElementById('home-total').innerText = `${metrics.raw.total.toLocaleString()}ëª…`;
      document.getElementById('home-rep-score').innerText = `${metrics.repScore} / 100`;
      document.getElementById('home-my-vote').innerText = userVoteMap[hotIssue.id] || 'ëŒ€ê¸°';
      renderPreview(metrics.raw);
      renderCategoryTabs();
      renderIssueList(metricsMap);
    }

    function renderCategoryTabs() {
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      ISSUE_CATEGORIES.forEach((cat) => {
        const btn = document.createElement('button');
        const active = activeCategory === cat;
        btn.className = `px-3 py-2 rounded-full border text-sm font-semibold whitespace-nowrap ${active ? 'bg-blue-600 text-white border-blue-600 shadow' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300'}`;
        btn.innerText = cat;
        btn.onclick = (e) => {
          e.stopPropagation();
          activeCategory = cat;
          renderCategoryTabs();
          renderIssueList(latestMetricsMap);
        };
        container.appendChild(btn);
      });
    }

    function renderIssueList(metricsMap) {
      const list = document.getElementById('issue-list');
      list.innerHTML = '';
      const filtered = ISSUES.filter((issue) => activeCategory === 'ì „ì²´' || issue.category === activeCategory);
      if (!filtered.length) {
        list.innerHTML = '<div class="bg-white p-4 rounded-2xl border text-sm text-gray-500">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      filtered.forEach((issue) => {
        const metrics = metricsMap[issue.id] || buildIssueMetrics(issue.id);
        const agree = metrics.raw.percents.ì°¬ì„± || 0;
        const neutral = metrics.raw.percents.ì¤‘ë¦½ || 0;
        const disagree = metrics.raw.percents.ë°˜ëŒ€ || 0;
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:-translate-y-0.5 hover:shadow-md transition duration-150';
        card.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div>
              <p class="text-xs text-gray-500">${issue.category}</p>
              <h3 class="font-bold text-lg text-gray-900">${issue.title}</h3>
              <p class="text-xs text-gray-500 mt-1">${issue.description}</p>
            </div>
            <button class="text-sm text-blue-600 font-semibold" onclick="openDetail('${issue.id}')">ìì„¸íˆ</button>
          </div>
          <div class="w-full h-8 bg-gray-100 rounded-full flex overflow-hidden mb-2">
            <div style="width:${agree}%" class="h-full bg-blue-600"></div>
            <div style="width:${neutral}%" class="h-full bg-gray-400"></div>
            <div style="width:${disagree}%" class="h-full bg-red-500"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 font-medium">
            <span class="text-blue-600">ì°¬ì„± ${agree}%</span>
            <span class="text-gray-600">ì¤‘ë¦½ ${neutral}%</span>
            <span class="text-red-600">ë°˜ëŒ€ ${disagree}%</span>
          </div>
          <div class="mt-2 text-xs text-gray-500">ì´ ${metrics.raw.total.toLocaleString()}ëª… Â· ëŒ€í‘œì„± ${metrics.repScore}/100</div>`;
        list.appendChild(card);
      });
    }

    function openDetail(issueId) {
      if (issueId) setSelectedIssue(issueId);
      renderAll();
      setView('detail');
    }

    function renderDetail(metricsMap) {
      const issue = getSelectedIssue();
      const metrics = metricsMap[issue.id] || buildIssueMetrics(issue.id);
      const raw = metrics.raw;
      const corrected = metrics.corrected;
      const ageStats = metrics.ageStats;
      const repScore = metrics.repScore;

      document.getElementById('detail-category').innerText = issue.category;
      document.getElementById('detail-title').innerText = issue.title;
      document.getElementById('total-vote-count').innerText = `ì´ ${raw.total.toLocaleString()}ëª… ì°¸ì—¬`;
      document.getElementById('detail-rep-score').innerText = repScore || 0;

      document.getElementById('bar-agree').style.width = `${raw.percents.ì°¬ì„± || 0}%`;
      document.getElementById('bar-neutral').style.width = `${raw.percents.ì¤‘ë¦½ || 0}%`;
      document.getElementById('bar-disagree').style.width = `${raw.percents.ë°˜ëŒ€ || 0}%`;
      document.getElementById('bar-agree').innerText = raw.percents.ì°¬ì„± > 5 ? `${raw.percents.ì°¬ì„±}%` : '';
      document.getElementById('bar-neutral').innerText = raw.percents.ì¤‘ë¦½ > 5 ? `${raw.percents.ì¤‘ë¦½}%` : '';
      document.getElementById('bar-disagree').innerText = raw.percents.ë°˜ëŒ€ > 5 ? `${raw.percents.ë°˜ëŒ€}%` : '';
      document.getElementById('percent-agree').innerText = `ì°¬ì„± ${raw.percents.ì°¬ì„± || 0}%`;
      document.getElementById('percent-neutral').innerText = `ì¤‘ë¦½ ${raw.percents.ì¤‘ë¦½ || 0}%`;
      document.getElementById('percent-disagree').innerText = `ë°˜ëŒ€ ${raw.percents.ë°˜ëŒ€ || 0}%`;

      const warningBox = document.getElementById('bias-warnings');
      warningBox.innerHTML = '';
      metrics.warnings.forEach((text) => {
        const row = document.createElement('div');
        row.className = 'flex items-start gap-2 text-sm text-gray-700 bg-slate-50 border border-slate-100 px-3 py-2 rounded-xl';
        row.innerHTML = `<span class="material-symbols-outlined text-base text-amber-500">warning</span><span>${text}</span>`;
        warningBox.appendChild(row);
      });

      updateEvidence(issue.id);
      renderComments(issue.id);
      refreshVoteButtons();
      renderCharts(raw, corrected, ageStats);
      renderExternalOpinions(issue.id, metrics);
    }

    function refreshVoteButtons() {
      ['vote-agree', 'vote-neutral', 'vote-disagree'].forEach((btnId) => {
        const btn = document.getElementById(btnId);
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'border-blue-500', 'border-gray-400', 'border-red-500', 'shadow-md');
      });
      const myVote = userVoteMap[getSelectedIssue().id];
      if (!myVote) return;
      ['vote-agree', 'vote-neutral', 'vote-disagree'].forEach((btnId) => {
        const btn = document.getElementById(btnId);
        if (btnId.includes(myVote === 'ì°¬ì„±' ? 'agree' : myVote === 'ì¤‘ë¦½' ? 'neutral' : 'disagree')) {
          btn.classList.add('border-blue-500', 'shadow-md');
        } else {
          btn.classList.add('opacity-50');
          btn.disabled = true;
        }
      });
    }

    function updateEvidence(issueId) {
      const list = document.getElementById('evidence-list');
      const data = EVIDENCE[issueId]?.[activeEvidenceTab] || [];
      document.querySelectorAll('.tab-btn').forEach((btn) => {
        btn.classList.remove('border-indigo-600', 'text-indigo-600', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-500', 'font-medium');
      });
      const activeBtn = document.getElementById(`tab-${activeEvidenceTab}`);
      activeBtn.classList.add('border-indigo-600', 'text-indigo-600', 'font-semibold');
      activeBtn.classList.remove('border-transparent', 'text-gray-500', 'font-medium');

      list.innerHTML = '';
      if (!data.length) {
        list.innerHTML = '<div class="bg-gray-50 p-4 rounded-xl text-sm text-gray-500 text-center">ë“±ë¡ëœ ê·¼ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      data.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'p-4 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors';
        card.innerHTML = `
          <div class="flex items-start">
            <span class="material-symbols-outlined text-sm text-indigo-500 mr-2 mt-0.5">link</span>
            <div class="flex-1">
              <p class="text-sm font-semibold text-gray-800 line-clamp-2">${item.title}</p>
              <p class="text-xs text-gray-500 mt-1">${item.source}</p>
            </div>
            <a href="${item.link}" target="_blank" class="ml-3 text-xs text-indigo-500 hover:text-indigo-700 font-medium">ì›ë¬¸ ë³´ê¸°</a>
          </div>`;
        list.appendChild(card);
      });
    }

    function selectEvidenceTab(type) {
      activeEvidenceTab = type;
      updateEvidence(getSelectedIssue().id);
    }

    function renderComments(issueId) {
      const container = document.getElementById('comment-list');
      const data = COMMENTS[issueId] || [];
      document.getElementById('comment-count').innerText = data.length;
      container.innerHTML = '';
      data.forEach((c) => {
        let color = 'bg-blue-100 text-blue-600';
        if (c.type === 'ì¤‘ë¦½') color = 'bg-gray-100 text-gray-600';
        if (c.type === 'ë°˜ëŒ€') color = 'bg-red-100 text-red-600';
        const row = document.createElement('div');
        row.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100';
        row.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <span class="px-1.5 py-0.5 rounded ${color} text-[10px] font-bold">${c.type}</span>
            <span class="text-xs text-gray-800 font-semibold">${c.nickname}</span>
            <span class="text-xs text-gray-500 font-medium">${c.meta}</span>
          </div>
          <p class="text-sm text-gray-800 leading-relaxed mb-3">${c.content}</p>
          <div class="flex items-center gap-4 text-xs text-gray-400">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">thumb_up</span>
              ê³µê° ${c.likes}
            </span>
          </div>`;
        container.appendChild(row);
      });
    }

    // ì™¸ë¶€ SNS ì—¬ë¡ (íŠ¸ìœ„í„°/ì»¤ë®¤ë‹ˆí‹°) ìš”ì•½ ë° í”„ë ˆì„ ì¹´ë“œ ë Œë”ë§
    function renderExternalOpinions(issueId, metrics) {
      const cardContainer = document.getElementById('external-narratives');
      const sampleLabel = document.getElementById('external-sample');
      const config = EXTERNAL_OPINIONS[issueId];
      if (!cardContainer || !config) return;
      NARRATIVE_COMMENTS[issueId] = NARRATIVE_COMMENTS[issueId] || {};
      cardContainer.innerHTML = '';
      sampleLabel.innerText = `SNS ìƒ˜í”Œ ${config.sampleSize.toLocaleString()}ê±´`;

      const sns = config.snsRatio;
      const platform = {
        ì°¬ì„±: metrics.raw.percents['ì°¬ì„±'] || 0,
        ì¤‘ë¦½: metrics.raw.percents['ì¤‘ë¦½'] || 0,
        ë°˜ëŒ€: metrics.raw.percents['ë°˜ëŒ€'] || 0
      };
      const ctxCanvas = document.getElementById('chart-external');
      if (ctxCanvas) {
        const ctx = ctxCanvas.getContext('2d');
        const chartData = {
          labels: ['í”Œë«í¼', 'SNS'],
          datasets: [
            { label: 'ì°¬ì„±', data: [platform.ì°¬ì„± || 0, sns.ì°¬ì„±], backgroundColor: COLORS.ì°¬ì„±, stack: 'ext' },
            { label: 'ì¤‘ë¦½', data: [platform.ì¤‘ë¦½ || 0, sns.ì¤‘ë¦½], backgroundColor: COLORS.ì¤‘ë¦½, stack: 'ext' },
            { label: 'ë°˜ëŒ€', data: [platform.ë°˜ëŒ€ || 0, sns.ë°˜ëŒ€], backgroundColor: COLORS.ë°˜ëŒ€, stack: 'ext' }
          ]
        };
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x.toFixed(1)}%` } }
          },
          scales: {
            x: { stacked: true, min: 0, max: 100, ticks: { stepSize: 20, callback: (v) => `${v}%` }, grid: { color: 'rgba(148,163,184,0.25)' } },
            y: { stacked: true, grid: { display: false } }
          }
        };
        if (charts.external) {
          charts.external.data = chartData;
          charts.external.options = options;
          charts.external.update();
        } else {
          charts.external = new Chart(ctx, { type: 'bar', data: chartData, options });
        }
      }

      config.narratives.forEach((narrative) => {
        const stanceColor = narrative.stance === 'ì°¬ì„±' ? 'bg-blue-100 text-blue-700' : narrative.stance === 'ë°˜ëŒ€' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
        const anomalyTag = narrative.isAnomaly ? '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-amber-100 text-amber-700 border border-amber-200">ì´ìƒ í™•ì‚° íŒ¨í„´ ê°ì§€ (Mock)</span>' : '';
        const comments = NARRATIVE_COMMENTS[issueId][narrative.id] || [];
        const card = document.createElement('div');
        card.className = 'bg-gray-50 border border-gray-100 rounded-2xl p-4 hover:-translate-y-0.5 hover:shadow-md transition duration-150';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-2">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full text-[10px] font-bold ${stanceColor}">${narrative.stance} í”„ë ˆì„</span>
              ${anomalyTag}
            </div>
            <span class="text-xs text-gray-500">ì˜ê²¬ìˆ˜ ${comments.length}ê°œ</span>
          </div>
          <p class="font-semibold text-gray-900 mb-1">${narrative.title}</p>
          <p class="text-sm text-gray-600 mb-3">${narrative.summary}</p>
          <div class="flex gap-2 mb-3">
            <button class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:-translate-y-0.5 active:scale-[0.98] transition duration-150" data-action="support">ì§€ì§€ ì˜ê²¬ ì“°ê¸°</button>
            <button class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:-translate-y-0.5 active:scale-[0.98] transition duration-150" data-action="oppose">ë°˜ë°• ì˜ê²¬ ì“°ê¸°</button>
          </div>
          <div class="hidden flex-col gap-2 mb-3" data-form>
            <textarea class="w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" rows="2" placeholder="í•œ ì¤„ ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            <button class="self-end px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 active:scale-[0.98] transition duration-150" data-submit>ë“±ë¡</button>
          </div>
          <div class="space-y-2" data-comments></div>
        `;

        const form = card.querySelector('[data-form]');
        const textarea = form.querySelector('textarea');
        const submitBtn = form.querySelector('[data-submit]');
        const commentBox = card.querySelector('[data-comments]');

        const renderCommentList = () => {
          commentBox.innerHTML = '';
          comments.slice(0, 3).forEach((c) => {
            const row = document.createElement('div');
            row.className = 'text-sm text-gray-800 bg-white border border-gray-100 rounded-xl px-3 py-2 flex items-center gap-2';
            row.innerHTML = `<span class="px-1.5 py-0.5 rounded ${c.type === 'ì§€ì§€' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'} text-[10px] font-bold">${c.type}</span><span class="font-semibold">${c.nickname}</span><span class="text-gray-500">${c.content}</span>`;
            commentBox.appendChild(row);
          });
        };
        renderCommentList();

        card.querySelector('[data-action="support"]').addEventListener('click', () => {
          form.classList.toggle('hidden');
          form.dataset.type = 'ì§€ì§€';
        });
        card.querySelector('[data-action="oppose"]').addEventListener('click', () => {
          form.classList.toggle('hidden');
          form.dataset.type = 'ë°˜ë°•';
        });
        submitBtn.addEventListener('click', () => {
          const content = textarea.value.trim();
          if (!content) return showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          const type = form.dataset.type || 'ì§€ì§€';
          const nickname = currentUser?.name || 'ìµëª…';
          comments.unshift({ type, nickname, content, createdAt: Date.now() });
          NARRATIVE_COMMENTS[issueId][narrative.id] = comments;
          textarea.value = '';
          form.classList.add('hidden');
          renderCommentList();
          showToast('ì˜ê²¬ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });

        cardContainer.appendChild(card);
      });
    }

    function addCommentFromPrompt() {
      if (!ensureLoggedIn()) return;
      const issueId = getSelectedIssue().id;
      COMMENTS[issueId] = COMMENTS[issueId] || [];
      const voteType = userVoteMap[issueId] || 'ì¤‘ë¦½';
      COMMENTS[issueId].unshift({ type: voteType, nickname: 'ë‚˜', meta: `${userProfile?.ageGroup || 'ì—°ë ¹ ë¯¸ì •'} Â· ${userProfile?.region || 'ì§€ì—­ ë¯¸ì •'}`, content: 'ì˜ê²¬ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤.', likes: 0 });
      renderComments(issueId);
      showToast('ì˜ê²¬ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„ì‹œ)', 'success');
    }

    function renderPreview(raw) {
      const canvas = document.getElementById('preview-raw');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const data = [raw.percents.ì°¬ì„± || 0, raw.percents.ì¤‘ë¦½ || 0, raw.percents.ë°˜ëŒ€ || 0];
      const baseConfig = horizontalStackOptions();
      const chartData = {
        labels: ['ì „ì²´'],
        datasets: [
          { label: 'ì°¬ì„±', data: [data[0]], backgroundColor: COLORS.ì°¬ì„±, stack: 'stack1' },
          { label: 'ì¤‘ë¦½', data: [data[1]], backgroundColor: COLORS.ì¤‘ë¦½, stack: 'stack1' },
          { label: 'ë°˜ëŒ€', data: [data[2]], backgroundColor: COLORS.ë°˜ëŒ€, stack: 'stack1' }
        ]
      };
      if (charts.preview) {
        charts.preview.data = chartData;
        charts.preview.update();
        return;
      }
      charts.preview = new Chart(ctx, { type: 'bar', data: chartData, options: baseConfig });
    }

    function renderCharts(raw, corrected, ageStats) {
      const rawCanvas = document.getElementById('chart-raw');
      const correctedCanvas = document.getElementById('chart-corrected');
      const ageCanvas = document.getElementById('chart-age');
      if (!rawCanvas || !correctedCanvas || !ageCanvas) return;

      const rawCtx = rawCanvas.getContext('2d');
      const correctedCtx = correctedCanvas.getContext('2d');
      const ageCtx = ageCanvas.getContext('2d');
      if (!rawCtx || !correctedCtx || !ageCtx) return;

      const rawPercent = [raw.percents.ì°¬ì„± || 0, raw.percents.ì¤‘ë¦½ || 0, raw.percents.ë°˜ëŒ€ || 0];
      const correctedPercent = [corrected.ì°¬ì„± || 0, corrected.ì¤‘ë¦½ || 0, corrected.ë°˜ëŒ€ || 0];

      const baseConfig = horizontalStackOptions();

      const rawData = {
        labels: ['ì „ì²´'],
        datasets: [
          { label: 'ì°¬ì„±', data: [rawPercent[0]], backgroundColor: COLORS.ì°¬ì„±, stack: 'stack1' },
          { label: 'ì¤‘ë¦½', data: [rawPercent[1]], backgroundColor: COLORS.ì¤‘ë¦½, stack: 'stack1' },
          { label: 'ë°˜ëŒ€', data: [rawPercent[2]], backgroundColor: COLORS.ë°˜ëŒ€, stack: 'stack1' }
        ]
      };

      const correctedData = {
        labels: ['ì „ì²´'],
        datasets: [
          { label: 'ì°¬ì„±', data: [correctedPercent[0]], backgroundColor: COLORS.ì°¬ì„±, stack: 'stack2' },
          { label: 'ì¤‘ë¦½', data: [correctedPercent[1]], backgroundColor: COLORS.ì¤‘ë¦½, stack: 'stack2' },
          { label: 'ë°˜ëŒ€', data: [correctedPercent[2]], backgroundColor: COLORS.ë°˜ëŒ€, stack: 'stack2' }
        ]
      };

      if (charts.raw) { charts.raw.data = rawData; charts.raw.update(); }
      else { charts.raw = new Chart(rawCtx, { type: 'bar', data: rawData, options: baseConfig }); }

      if (charts.corrected) { charts.corrected.data = correctedData; charts.corrected.update(); }
      else { charts.corrected = new Chart(correctedCtx, { type: 'bar', data: correctedData, options: baseConfig }); }

      const ageLabels = AGE_GROUPS.map((g) => g.label);
      const ageAgree = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.ì°¬ì„± / stat.total) * 1000) / 10;
      });
      const ageNeutral = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.ì¤‘ë¦½ / stat.total) * 1000) / 10;
      });
      const ageDisagree = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.ë°˜ëŒ€ / stat.total) * 1000) / 10;
      });

      const ageOptions = {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: (ctx) => `${ctx.label} - ${ctx.dataset.label} ${ctx.parsed.x.toFixed(1)}%` } }
        },
        scales: {
          x: { stacked: true, ticks: { callback: (v) => `${v}%`, stepSize: 20 }, max: 100, min: 0, grid: { color: 'rgba(148,163,184,0.25)' } },
          y: { stacked: true, grid: { display: false } }
        }
      };

      const ageData = {
        labels: ageLabels,
        datasets: [
          { label: 'ì°¬ì„±', data: ageAgree, backgroundColor: COLORS.ì°¬ì„± },
          { label: 'ì¤‘ë¦½', data: ageNeutral, backgroundColor: COLORS.ì¤‘ë¦½ },
          { label: 'ë°˜ëŒ€', data: ageDisagree, backgroundColor: COLORS.ë°˜ëŒ€ }
        ]
      };

      if (charts.age) { charts.age.data = ageData; charts.age.update(); }
      else { charts.age = new Chart(ageCtx, { type: 'bar', data: ageData, options: ageOptions }); }
    }

    function horizontalStackOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12 } },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x.toFixed(1)}%` } }
        },
        scales: {
          x: { stacked: true, min: 0, max: 100, ticks: { stepSize: 20, callback: (v) => `${v}%` }, grid: { color: 'rgba(148,163,184,0.25)' } },
          y: { stacked: true, display: false }
        }
      };
    }

    function handleVote(type) {
      const choiceMap = { agree: 'ì°¬ì„±', neutral: 'ì¤‘ë¦½', disagree: 'ë°˜ëŒ€' };
      const issueId = getSelectedIssue().id;
      if (!ensureProfile()) return;
      if (userVoteMap[issueId]) {
        showToast('ì´ë¯¸ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'error');
        setView('detail');
        return;
      }
      const voteRecord = {
        issueId,
        choice: choiceMap[type],
        age_group: userProfile.ageGroup,
        region: userProfile.region,
        timestamp: Date.now(),
        userId: currentUser?.id || 'guest'
      };
      votes.push(voteRecord);
      userVoteMap[issueId] = choiceMap[type];
      saveJSON(STORAGE_KEYS.votes, votes);
      saveJSON(STORAGE_KEYS.userVote, userVoteMap);
      showToast('íˆ¬í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      renderAll();
      setView('detail');
    }

    function getRepresentationHint(issueId) {
      if (!currentUser) return 'ë¡œê·¸ì¸ í›„ ëŒ€í‘œì„± ì•ˆë‚´ê°€ ì œê³µë©ë‹ˆë‹¤.';
      if (!userProfile) return 'ì—°ë ¹ëŒ€Â·ê±°ì£¼ì§€ë¥¼ ì…ë ¥í•˜ë©´ ëŒ€í‘œì„± ê¸°ì—¬ë„ë¥¼ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.';
      const metrics = latestMetricsMap[issueId] || buildIssueMetrics(issueId);
      const stat = metrics.ageStats[userProfile.ageGroup] || { total: 0 };
      const total = metrics.raw.total || 0;
      const popRatio = AGE_GROUPS.find((g) => g.id === userProfile.ageGroup)?.populationRatio || 0;
      const sampleRatio = total ? (stat.total || 0) / total : 0;
      if (!total) return 'ì•„ì§ í‘œë³¸ì´ ì ìŠµë‹ˆë‹¤. ì²« íˆ¬í‘œë¡œ ëŒ€í‘œì„±ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.';
      if (sampleRatio < popRatio * 0.6) return 'ë‹¹ì‹ ì˜ ì—°ë ¹ëŒ€ ì°¸ì—¬ê°€ ë¶€ì¡±í•´ ë‹¹ì‹ ì˜ í•œ í‘œê°€ íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤.';
      if (sampleRatio > popRatio * 1.4) return 'ë‹¹ì‹ ì˜ ì—°ë ¹ëŒ€ëŠ” ì´ë¯¸ ë§ì´ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤. ë³´ì •ì´ ì ìš©ë©ë‹ˆë‹¤.';
      return 'ê· í˜• ì¡íŒ í‘œë³¸ì…ë‹ˆë‹¤. ê³„ì† ì°¸ì—¬í•´ ì£¼ì„¸ìš”.';
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const colorMap = { success: 'bg-emerald-500', error: 'bg-rose-500', info: 'bg-gray-800' };
      toast.className = `${colorMap[type] || colorMap.info} text-white px-3 py-2 rounded-xl shadow-lg text-sm`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-4px)'; }, 2500);
      setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
    }
  </script>
</body>
</html>
