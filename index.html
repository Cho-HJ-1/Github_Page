<!-- update: keep list-style layout + hero card, add analysis (weights/age) in detail, switch all doughnut charts to horizontal stacked bars -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>대한민국 진짜 여론 MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" as="style" crossorigin="" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background-color: #F5F7FA; }
    .card { box-shadow: 0 18px 50px -24px rgba(15, 23, 42, 0.4); }
    .pulse-dot { box-shadow: 0 0 0 rgba(59,130,246,0.4); animation: pulse 1.8s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.35); } 70% { box-shadow: 0 0 0 14px rgba(59,130,246,0); } 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); } }
    .page-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
    .fade-enter { opacity: 0; transform: translateY(10px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); }
    .bar-fill { transition: width 0.5s ease; }
  </style>
</head>
<body class="bg-[#F5F7FA] text-gray-900 min-h-screen pb-20">
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- 로그인 / 회원가입 (Mock) -->
  <div id="login-modal" class="fixed inset-0 bg-black/70 text-white hidden items-center justify-center px-4 z-[140]">
    <div class="bg-white text-gray-900 rounded-3xl w-full max-w-md p-6 card space-y-4 relative">
      <div>
        <p class="text-xs text-blue-600 font-semibold mb-1">참여 전 로그인</p>
        <h2 class="text-xl font-bold leading-snug">대한민국 진짜 여론에 참여하려면 로그인이 필요합니다.</h2>
        <p class="text-sm text-gray-600 mt-2">OAuth는 시연용 Mock 입니다. 어떤 버튼을 눌러도 가짜 계정이 생성됩니다.</p>
      </div>
      <div class="space-y-2">
        <button id="login-kakao" class="w-full py-3 rounded-xl bg-[#FEE500] text-gray-900 font-semibold shadow hover:translate-y-[-1px] transition">카카오로 계속하기</button>
        <button id="login-naver" class="w-full py-3 rounded-xl bg-[#03C75A] text-white font-semibold shadow hover:translate-y-[-1px] transition">네이버로 계속하기</button>
        <button id="login-google" class="w-full py-3 rounded-xl bg-white border border-gray-200 text-gray-800 font-semibold shadow hover:translate-y-[-1px] transition">구글로 계속하기</button>
        <button id="login-email" class="w-full py-3 rounded-xl bg-gray-900 text-white font-semibold shadow hover:translate-y-[-1px] transition">이메일로 계속하기 (Mock)</button>
      </div>
      <p class="text-xs text-gray-500">로그인 후 연령대·거주지를 설정하면 보정 정확도가 높아집니다.</p>
    </div>
  </div>

  <!-- 프로필 / 한국인 인증 (Mock) -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center px-4 z-[120]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 card relative">
      <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600" onclick="closeProfileModal()">x</button>
      <div class="flex items-center gap-2 mb-4">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">K</div>
        <div>
          <p class="text-sm text-gray-500">한국인 인증 (Mock)</p>
          <p class="font-semibold text-gray-900">연령대 · 거주지 설정</p>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <label class="text-sm font-semibold text-gray-700">연령대</label>
          <select id="profile-age" class="mt-2 w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
            <option value="">선택하세요</option>
            <option>10대</option>
            <option>20대</option>
            <option>30대</option>
            <option>40대</option>
            <option>50대</option>
            <option>60+</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">거주지</label>
          <select id="profile-region" class="mt-2 w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
            <option value="">선택하세요</option>
            <option>서울/수도권</option>
            <option>지방</option>
            <option>해외</option>
          </select>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 border border-gray-100 p-3 rounded-xl">
          <span class="material-symbols-outlined text-base text-blue-500">verified_user</span>
          실명/통신사는 묻지 않습니다. 연령·거주지만 확보해 여론 보정을 준비합니다.
        </div>
        <button onclick="saveProfile()" class="w-full py-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold shadow-md hover:shadow-lg transition">인증 정보 저장</button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
    <div class="max-w-3xl mx-auto px-4 h-14 flex items-center justify-between relative">
      <div class="flex items-center gap-2 cursor-pointer" onclick="setView('home')">
        <span class="material-symbols-outlined text-blue-600 text-2xl">how_to_vote</span>
        <div>
          <p class="text-xs text-gray-500">대한민국 진짜 여론</p>
          <p class="font-semibold">조작 없는 MVP</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-1 text-xs text-blue-600 font-semibold bg-blue-50 px-3 py-1 rounded-full">
          <span class="w-2 h-2 rounded-full bg-blue-500 pulse-dot"></span>
          한국인 인증(Mock)
        </div>
        <button id="btn-open-profile" class="p-2 rounded-full hover:bg-gray-100 text-xl leading-none" aria-label="프로필 열기">👤</button>
      </div>

      <!-- 사용자 정보 패널 -->
      <div id="user-panel" class="hidden absolute right-0 top-14 w-72 bg-white border border-gray-200 rounded-2xl shadow-xl p-4 z-[130] space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs text-gray-500" id="user-panel-provider">로그인 필요</p>
            <p class="text-lg font-semibold text-gray-900" id="user-panel-name">게스트</p>
            <p class="text-sm text-gray-600 mt-1" id="user-panel-profile">연령·거주지 미입력</p>
          </div>
          <span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700" id="user-panel-rep-tag">대표성 안내</span>
        </div>
        <p class="text-xs text-gray-500 leading-relaxed" id="user-panel-rep-msg">연령대 정보를 입력하면 대표성 기여도를 안내해 드립니다.</p>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="openProfileModal()" class="py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:border-blue-500 hover:text-blue-600 transition">연령대·거주지 수정</button>
          <button onclick="logout()" class="py-2 rounded-xl bg-gray-900 text-white text-sm font-semibold hover:bg-gray-800 transition">로그아웃</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 pt-4">
    <section id="view-home" class="page-transition">
      <h2 class="text-xl font-extrabold text-gray-800 mb-4">이슈 목록</h2>

      <!-- 히어로: 오늘의 이슈 + 대표성 카드 -->
      <div id="hero-card" class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-3xl shadow-xl text-white p-6 md:p-7 relative overflow-hidden mb-3 cursor-pointer">
        <div class="absolute inset-0 opacity-25 bg-[radial-gradient(circle_at_top_left,_rgba(255,255,255,0.35)_0,_transparent_45%)]"></div>
        <div class="relative z-10 flex flex-col gap-4">
          <div class="flex items-center gap-2 text-xs md:text-sm">
            <span class="px-3 py-1 rounded-full bg-white/15 text-[11px] font-semibold tracking-wide uppercase">오늘의 이슈</span>
            <span id="home-category" class="px-3 py-1 rounded-full bg-white/15 border border-white/20 text-white text-[11px] font-semibold">정책</span>
          </div>
          <div>
            <h1 id="home-title" class="text-2xl md:text-3xl font-extrabold leading-snug">국민연금 개혁안, 동의하십니까?</h1>
            <p id="home-description" class="text-sm md:text-base text-blue-50 mt-2">세대별 편향을 보정한 진짜 여론을 보여줍니다.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-white/15 rounded-2xl px-3 py-3 border border-white/10">
              <p class="text-blue-100 text-xs">총 참여</p>
              <p id="home-total" class="text-xl font-bold">0명</p>
            </div>
            <div class="bg-white/15 rounded-2xl px-3 py-3 border border-white/10">
              <p class="text-blue-100 text-xs">대표성 점수</p>
              <p id="home-rep-score" class="text-xl font-bold">0 / 100</p>
            </div>
            <div class="bg-white/15 rounded-2xl px-3 py-3 border border-white/10">
              <p class="text-blue-100 text-xs">내 투표</p>
              <p id="home-my-vote" class="text-xl font-bold">대기</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 mt-1">
            <button id="btn-hero-vote" class="px-4 py-3 rounded-xl bg-white text-blue-600 font-semibold shadow-md hover:bg-blue-50 hover:-translate-y-0.5 active:scale-95 transition transform">지금 투표하기</button>
            <button id="btn-hero-view" class="px-4 py-3 rounded-xl bg-white/90 text-indigo-700 font-semibold border border-white/60 hover:bg-white hover:-translate-y-0.5 active:scale-95 transition transform">여론 자세히 보기</button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-blue-100 p-4 shadow-sm mb-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-xs text-blue-600 font-semibold">Raw 여론 미리보기</p>
            <p class="text-sm text-slate-600">가로 스택으로 실시간 확인</p>
          </div>
          <span class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-[11px] font-semibold border border-blue-100">실험</span>
        </div>
        <div class="h-28">
          <canvas id="preview-raw" class="h-full"></canvas>
        </div>
      </div>

      <div class="flex items-center gap-2 overflow-x-auto pb-3 mb-2 -mx-1 px-1" id="category-tabs"></div>

      <!-- 기존 스타일 이슈 카드 리스트 -->
      <div id="issue-list" class="space-y-4 mb-12"></div>
    </section>

    <section id="view-detail" class="page-transition hidden">
      <button onclick="setView('home')" class="mb-4 flex items-center text-gray-500 hover:text-gray-700 transition-colors">
        <span class="material-symbols-outlined text-xl mr-1">arrow_back_ios</span>
        <span class="text-sm font-medium">목록으로</span>
      </button>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <span id="detail-category" class="px-2 py-0.5 rounded bg-gray-50 text-gray-500 text-[11px] font-bold mb-2 inline-block">정책</span>
        <h2 id="detail-title" class="text-2xl font-bold text-gray-900 mb-4 leading-snug">국민연금 개혁안, 동의하십니까?</h2>

        <div id="vote-area" class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-700">당신의 의견은 무엇인가요?</h3>
            <span class="text-xs text-gray-400 font-medium">1인 1표, 수정 불가</span>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <button id="vote-agree" onclick="handleVote('agree')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-blue-500 hover:bg-blue-50 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">찬성</button>
            <button id="vote-neutral" onclick="handleVote('neutral')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-gray-400 hover:bg-gray-100 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">중립</button>
            <button id="vote-disagree" onclick="handleVote('disagree')" class="p-3 rounded-xl border-2 border-gray-200 text-gray-700 font-medium hover:border-red-500 hover:bg-red-50 transition-all duration-150 hover:-translate-y-0.5 active:scale-[0.98]">반대</button>
          </div>
        </div>

        <div id="result-area" class="border-t border-gray-100 pt-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600 text-xl">insights</span>
            실시간 투표 결과 (전체)
          </h3>
          <div id="total-vote-count" class="text-sm text-gray-500 mb-3 font-medium">총 0명 참여</div>

          <div class="w-full h-8 bg-gray-100 rounded-full flex overflow-hidden mb-2">
            <div id="bar-agree" style="width: 0%" class="h-full bg-blue-600 bar-fill flex items-center justify-center text-[10px] text-white font-bold px-1"></div>
            <div id="bar-neutral" style="width: 0%" class="h-full bg-gray-400 bar-fill flex items-center justify-center text-[10px] text-gray-800 font-bold px-1"></div>
            <div id="bar-disagree" style="width: 0%" class="h-full bg-red-600 bar-fill flex items-center justify-center text-[10px] text-white font-bold px-1"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 font-medium px-1">
            <span id="percent-agree" class="text-blue-600">찬성 0%</span>
            <span id="percent-neutral" class="text-gray-600">중립 0%</span>
            <span id="percent-disagree" class="text-red-600">반대 0%</span>
          </div>
        </div>
      </div>

      <!-- 여론 분석 섹션 -->
      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <div>
            <p class="text-xs text-gray-500">보정 + 편향 경고</p>
            <h3 class="text-xl font-bold text-gray-900">여론 분석 (Raw vs 보정)</h3>
            <p class="text-sm text-gray-600 mt-1">전체 여론(%)과 보정 여론(%)을 나란히 비교합니다. x축은 0~100% (20% 간격) 입니다.</p>
          </div>
          <div class="flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-emerald-50 text-emerald-700 font-semibold">
            <span class="material-symbols-outlined text-base">verified</span>
            <span>대표성 <span id="detail-rep-score">0</span>/100</span>
          </div>
        </div>
        <div id="bias-warnings" class="space-y-2 mb-4"></div>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-xs text-gray-500">Raw</p>
                <p class="font-bold">전체 여론</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-gray-700">가로 스택</span>
            </div>
            <div class="h-40"><canvas id="chart-raw"></canvas></div>
          </div>
          <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-xs text-gray-500">보정</p>
                <p class="font-bold">대한민국 인구 가중치 적용</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">가중 스택</span>
            </div>
            <div class="h-40"><canvas id="chart-corrected"></canvas></div>
          </div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-100 bg-gray-50/60">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs text-gray-500">연령별</p>
              <p class="font-bold">연령대별 찬·중·반 분포</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">stacked bar</span>
          </div>
          <div class="h-72"><canvas id="chart-age"></canvas></div>
        </div>
      </div>

      <!-- 외부 여론 레이더 -->
      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div>
            <p class="text-xs text-gray-500">SNS · 커뮤니티 요약</p>
            <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
              <span class="material-symbols-outlined text-indigo-600 text-xl">travel_explore</span>
              외부 여론 레이더 (SNS · 커뮤니티)
            </h3>
            <p class="text-sm text-gray-600 mt-1">sns에서 나타나는 여론과 플랫폼 여론을 비교합니다.</p>
          </div>
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">AI 분석 Mock</span>
        </div>
        <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4 mb-4">
          <div class="flex items-center justify-between mb-2 text-sm text-gray-700">
            <span class="font-semibold">플랫폼 여론 vs SNS 여론</span>
            <span id="external-sample" class="text-xs text-gray-500"></span>
          </div>
          <div class="h-40"><canvas id="chart-external"></canvas></div>
          <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
            <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">플랫폼</span>
            <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">SNS</span>
          </div>
        </div>
        <div id="external-narratives" class="space-y-3"></div>
      </div>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-xl text-indigo-600">menu_book</span>
          이슈 근거 자료 (Evidence)
        </h3>
        <div class="flex border-b border-gray-200 mb-4">
          <button id="tab-pro" onclick="selectEvidenceTab('pro', this)" class="tab-btn pb-2 px-4 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600 hover:text-indigo-700 transition-colors">찬성 근거 (Pro)</button>
          <button id="tab-con" onclick="selectEvidenceTab('con', this)" class="tab-btn pb-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">반대 근거 (Con)</button>
        </div>
        <div id="evidence-list" class="space-y-4"></div>
      </div>

      <div class="mb-20">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
          <div class="space-y-2">
            <p class="text-xs text-slate-500 font-semibold">이슈 참여</p>
            <div class="inline-flex bg-slate-100 rounded-full p-1 shadow-inner">
              <button id="what-tab-btn" class="px-4 py-2 rounded-full text-sm font-semibold bg-white shadow-sm text-slate-900 transition hover:-translate-y-0.5" data-tab="what">여론 의견 (What)</button>
              <button id="how-tab-btn" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 transition hover:text-slate-700" data-tab="how">해결책 제안 (How)</button>
            </div>
          </div>
        </div>

        <div id="what-panel" class="space-y-4">
          <p class="text-sm text-slate-600 bg-white border border-slate-100 rounded-2xl px-4 py-3">이 탭에서는 이슈에 대한 자유로운 의견을 나눕니다. 여론의 '무엇(What)'을 확인하는 영역입니다.</p>
          <div class="flex justify-between items-end">
            <h3 class="text-lg font-bold text-gray-900">최다 공감 의견 (<span id="comment-count">0</span>)</h3>
            <button onclick="addCommentFromPrompt()" class="text-sm text-blue-600 font-semibold hover:text-blue-800 transition-colors">임시 의견 추가</button>
          </div>
          <div id="comment-list" class="space-y-3"></div>
        </div>

        <div id="how-panel" class="space-y-5 hidden">
          <div class="bg-gradient-to-r from-slate-100 to-white border border-slate-200 rounded-2xl p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wide">대표 해결 흐름</p>
                <p class="text-sm text-slate-600">지지순 → 최신순으로 대표 흐름을 보여줍니다.</p>
              </div>
              <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold border border-blue-100">Flowchart</span>
            </div>
            <div id="solution-flow" class="space-y-2"></div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h4 class="text-lg font-bold text-slate-900">해결책 제안하기</h4>
              <span class="text-xs text-slate-500 font-semibold">필수 항목 *</span>
            </div>
            <div class="grid gap-3">
              <div>
                <label class="text-sm font-semibold text-slate-700">한 줄 요약 *</label>
                <input id="solution-title" type="text" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="예: 보험료 단계적 인상 + 취약계층 보전" />
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-700">설명 *</label>
                <textarea id="solution-summary" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="해결책의 핵심 아이디어를 적어주세요."></textarea>
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-700">정책 레버 (다중 선택)</label>
                <div id="lever-options" class="mt-2 flex flex-wrap gap-2"></div>
              </div>
              <div class="grid md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-semibold text-slate-700">예상 효과 (1-5) *</label>
                  <select id="solution-impact" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    <option value="">선택</option>
                    <option value="1">1 - 매우 낮음</option>
                    <option value="2">2 - 낮음</option>
                    <option value="3">3 - 보통</option>
                    <option value="4">4 - 높음</option>
                    <option value="5">5 - 매우 높음</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-700">실현 가능성 (1-5) *</label>
                  <select id="solution-feasibility" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    <option value="">선택</option>
                    <option value="1">1 - 매우 낮음</option>
                    <option value="2">2 - 낮음</option>
                    <option value="3">3 - 보통</option>
                    <option value="4">4 - 높음</option>
                    <option value="5">5 - 매우 높음</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-700">근거자료 URL (선택)</label>
                <input id="solution-evidence" type="url" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="https://..." />
              </div>
              <div class="grid md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-semibold text-slate-700">문제 정의 *</label>
                  <textarea id="flow-problem" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="현재 문제를 요약해주세요."></textarea>
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-700">원인 분석 *</label>
                  <textarea id="flow-cause" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="문제의 근본 원인을 적어주세요."></textarea>
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-700">전략 *</label>
                  <textarea id="flow-strategy" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="어떤 전략으로 접근하나요?"></textarea>
                </div>
                <div>
                  <label class="text-sm font-semibold text-slate-700">실행 *</label>
                  <textarea id="flow-actions" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="구체 실행 단계를 적어주세요."></textarea>
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm font-semibold text-slate-700">기대 결과 *</label>
                  <textarea id="flow-outcome" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" placeholder="실행 후 기대되는 변화를 적어주세요."></textarea>
                </div>
              </div>
              <div class="flex justify-end">
                <button id="solution-submit" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 hover:-translate-y-0.5 active:scale-95 transition transform" type="button">해결책 저장</button>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h4 class="text-lg font-bold text-slate-900">해결책 리스트</h4>
              <span class="text-xs text-slate-500">지지순 · 최신순</span>
            </div>
            <div id="solution-list" class="space-y-3"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const ISSUE_CATEGORIES = ['전체', '정치', '사회', '경제', '기타'];

    const ISSUES = [
      { id: 'issue-1', category: '정치', title: '국민연금 개혁안, 동의하십니까?', description: '보험료율 인상·연금 지급 개편 포함. 세대별 이해를 반영합니다.', isHot: true },
      { id: 'issue-2', category: '사회', title: '수도권 심야 대중교통 확대, 찬성하십니까?', description: '막차 연장·심야 버스 증편 비용을 감당할지 의견을 묻습니다.', isHot: false },
      { id: 'issue-3', category: '경제', title: '전기요금 연동제 재도입이 필요할까요?', description: '국제 에너지 가격 변동을 반영하는 요금제에 대한 질문입니다.', isHot: false },
      { id: 'issue-4', category: '기타', title: '실명제 소셜미디어 도입, 어떻게 생각하나요?', description: '악성 게시물 감소 vs 표현의 자유 침해 우려를 묻습니다.', isHot: false }
    ];

    const AGE_GROUPS = [
      { id: '10대', label: '10대', populationRatio: 0.09 },
      { id: '20대', label: '20대', populationRatio: 0.14 },
      { id: '30대', label: '30대', populationRatio: 0.16 },
      { id: '40대', label: '40대', populationRatio: 0.18 },
      { id: '50대', label: '50대', populationRatio: 0.19 },
      { id: '60+', label: '60+', populationRatio: 0.24 }
    ];

    const EVIDENCE = {
      'issue-1': {
        pro: [
          { title: '보험료율 상향으로 기금 고갈 시점 연기', source: '국회 예산정책처', link: '#' },
          { title: '청년층 부담 완화 위한 단계적 개편 필요', source: '연금연구원 브리프', link: '#' }
        ],
        con: [
          { title: '보험료 인상은 저소득층 역진성 우려', source: '시민단체 성명', link: '#' },
          { title: '급여 축소 시 노후소득 보장 약화', source: '학회 토론회', link: '#' }
        ]
      },
      'issue-2': {
        pro: [
          { title: '심야 이동권 보장을 위한 대중교통 확대 필요', source: '서울연구원', link: '#' },
          { title: '택시 수급 불균형 완화를 위해 심야버스 증편', source: '교통 정책 포럼', link: '#' }
        ],
        con: [
          { title: '심야 노선 확대 시 적자 부담 우려', source: '지자체 예산 보고서', link: '#' },
          { title: '안전 인력 확보 없이 연장은 위험', source: '노동조합 성명', link: '#' }
        ]
      },
      'issue-3': {
        pro: [
          { title: '연동제는 에너지 절약을 유도해 소비를 줄인다', source: '에너지경제연구원', link: '#' },
          { title: '국제 가격 급등 시 재정 부담을 분산', source: '산업부 브리핑', link: '#' }
        ],
        con: [
          { title: '요금 변동성 확대는 가계 불안을 키운다', source: '소비자연맹', link: '#' },
          { title: '산업 경쟁력 저하 우려', source: '무역협회 코멘트', link: '#' }
        ]
      },
      'issue-4': {
        pro: [
          { title: '실명제 도입 시 허위·악성 게시물 감소 가능', source: '인터넷윤리포럼', link: '#' },
          { title: '사이버 폭력 피해자 보호', source: '피해자 지원 단체', link: '#' }
        ],
        con: [
          { title: '익명성 제한은 표현의 자유 침해', source: '디지털인권 NGO', link: '#' },
          { title: '개인정보 유출 리스크 증가', source: '보안 컨퍼런스', link: '#' }
        ]
      }
    };

    const COMMENTS = {
      'issue-1': [
        { type: '찬성', nickname: '연금걱정없게', meta: '30대 · 수도권', content: '지금 손 안 대면 우리 세대가 다 부담합니다.', likes: 22 },
        { type: '반대', nickname: '은퇴준비중', meta: '60+ · 지방', content: '급여 줄이고 보험료 올리면 이중고입니다.', likes: 15 },
        { type: '중립', nickname: '밸런스러버', meta: '20대 · 수도권', content: '인상 폭을 세분화해서 세대별 차등이 필요해요.', likes: 11 }
      ],
      'issue-2': [
        { type: '찬성', nickname: '야근탈출', meta: '20대 · 수도권', content: '심야 이동권 확보가 최우선입니다.', likes: 14 },
        { type: '반대', nickname: '예산수호', meta: '40대 · 지방', content: '적자 보전은 결국 시민 부담입니다.', likes: 9 }
      ],
      'issue-3': [
        { type: '반대', nickname: '전기세걱정', meta: '30대 · 수도권', content: '요금 출렁이면 가계 계획 세우기 힘들어요.', likes: 7 },
        { type: '찬성', nickname: '에너지절약', meta: '50대 · 지방', content: '절약을 유도하려면 가격 신호가 필요합니다.', likes: 12 }
      ],
      'issue-4': [
        { type: '반대', nickname: '익명소중', meta: '20대 · 수도권', content: '익명성은 표현의 다양성을 지키는 장치입니다.', likes: 8 },
        { type: '찬성', nickname: '클린웹', meta: '40대 · 수도권', content: '실명제면 악플이 확 줄 것 같아요.', likes: 10 }
      ]
    };

    const EXTERNAL_OPINIONS = {
      'issue-1': {
        sampleSize: 1240,
        snsRatio: { 찬성: 62, 중립: 8, 반대: 30 },
        narratives: [
          { id: 'n1', stance: '찬성', title: '지금 개혁하지 않으면 청년 세대가 모든 부담을 진다', summary: '트위터에서 주로 2030 사용자들이 공유하는 프레임입니다.', isAnomaly: false },
          { id: 'n2', stance: '반대', title: '보험료만 올리고 급여는 깎이는 개악이다', summary: '특정 커뮤니티에서 반복적으로 등장하는 문장입니다.', isAnomaly: true },
          { id: 'n3', stance: '중립', title: '재정 건전성과 세대 형평을 함께 논의해야 한다', summary: '언론 기획 기사에서 균형 있게 언급됩니다.', isAnomaly: false }
        ]
      },
      'issue-2': {
        sampleSize: 820,
        snsRatio: { 찬성: 54, 중립: 18, 반대: 28 },
        narratives: [
          { id: 'n1', stance: '찬성', title: '심야 이동권 확보가 먼저다', summary: '야근/알바 종사자들이 지지하는 의견입니다.', isAnomaly: false },
          { id: 'n2', stance: '반대', title: '예산만 새고 이용자는 적다', summary: '커뮤니티에서 반복되는 비용 우려 프레임입니다.', isAnomaly: false }
        ]
      },
      'issue-3': {
        sampleSize: 960,
        snsRatio: { 찬성: 35, 중립: 25, 반대: 40 },
        narratives: [
          { id: 'n1', stance: '반대', title: '요금 변동성은 가계 불안을 키운다', summary: '소비자 커뮤니티 중심으로 확산된 주장입니다.', isAnomaly: false },
          { id: 'n2', stance: '찬성', title: '가격 신호가 있어야 절약이 가능하다', summary: '에너지 절약 캠페인에서 자주 언급됩니다.', isAnomaly: false }
        ]
      },
      'issue-4': {
        sampleSize: 710,
        snsRatio: { 찬성: 41, 중립: 17, 반대: 42 },
        narratives: [
          { id: 'n1', stance: '반대', title: '실명제는 표현의 자유를 훼손한다', summary: '디지털 인권 단체가 강조하는 메시지입니다.', isAnomaly: false },
          { id: 'n2', stance: '찬성', title: '실명제면 악성 게시물이 확 줄 것', summary: '커뮤니티 내 피해 사례 공유 글에서 주로 등장합니다.', isAnomaly: true }
        ]
      }
    };

    const NARRATIVE_COMMENTS = {};

    const STORAGE_KEYS = {
      profile: 'rr-profile',
      votes: 'rr-votes',
      userVote: 'rr-user-vote-map',
      user: 'rr-user'
    };

    const COLORS = {
      찬성: 'rgb(37, 99, 235)',
      중립: 'rgb(107, 114, 128)',
      반대: 'rgb(239, 68, 68)'
    };

    const POLICY_LEVERS = ['재정', '규제', '조직', '데이터/AI', '거버넌스', '커뮤니케이션'];

    const SOLUTION_STORAGE_KEYS = {
      solutions: 'solutions_v1',
      support: 'solution_support_v1'
    };

    const SEED_SOLUTIONS = {
      'issue-1': [
        {
          id: 'sol-1',
          issueId: 'issue-1',
          title: '보험료 단계적 인상 + 저소득층 보전',
          summary: '5년에 걸쳐 보험료율을 1%p씩 올리고 저소득층은 세액공제로 환급하는 하이브리드안입니다.',
          levers: ['재정', '거버넌스'],
          impactScore: 4,
          feasibilityScore: 3,
          evidenceUrl: '#',
          authorName: '정책러버',
          createdAt: Date.now() - 120000,
          supportCount: 12,
          flow: {
            problem: '2055년 기금 고갈 전망으로 세대 갈등이 커짐',
            cause: '보험료율 정체, 급여율 유지, 낮은 수익률',
            strategy: '점진적 보험료율 인상 + 취약계층 보전',
            actions: '국회 단계별 인상 법제화, 세액공제 신설, 사업주 분담 조정',
            outcome: '기금 고갈 연기, 청년 세대 부담 완화, 불신 감소'
          }
        },
        {
          id: 'sol-2',
          issueId: 'issue-1',
          title: '기금 수익률 제고 + 투명 공시',
          summary: '국민연금 기금운용을 성과연동 보상과 투명 공시로 개편해 수익률을 올립니다.',
          levers: ['조직', '데이터/AI'],
          impactScore: 3,
          feasibilityScore: 4,
          evidenceUrl: '#',
          authorName: '연금워치',
          createdAt: Date.now() - 90000,
          supportCount: 8,
          flow: {
            problem: '기금 고갈 불안이 커져 신뢰가 하락',
            cause: '운용 의사결정 폐쇄성, 성과연동 부족',
            strategy: '성과연동·공시 강화로 수익률 제고',
            actions: '기금운용위 민간전문가 확대, 월간 수익률 대시보드 공개',
            outcome: '수익률 상승, 정책 신뢰 회복'
          }
        }
      ],
      'issue-2': [
        {
          id: 'sol-3',
          issueId: 'issue-2',
          title: '심야 이동권 패스 + 민간 협력 노선',
          summary: '심야 전용 패스권을 도입하고 민간과 공동 운행해 적자를 줄입니다.',
          levers: ['재정', '거버넌스', '커뮤니케이션'],
          impactScore: 4,
          feasibilityScore: 4,
          evidenceUrl: '#',
          authorName: '모빌리티연구소',
          createdAt: Date.now() - 80000,
          supportCount: 10,
          flow: {
            problem: '심야 이동권 부족으로 시민 불편 증가',
            cause: '공공버스 적자 우려, 택시 공급 부족',
            strategy: '패스권 판매 + 민관 합동 노선 운영',
            actions: '심야 패스 사전 예약, 민간 버스·택시 노선 공모, 데이터 기반 배차',
            outcome: '적자 최소화하면서 이동권 확대, 체감 개선'
          }
        }
      ],
      'issue-3': [
        {
          id: 'sol-4',
          issueId: 'issue-3',
          title: '연동제 + 취약계층 에너지 바우처 확대',
          summary: '요금 연동제를 유지하되 저소득층 바우처를 자동 증액해 가격충격을 완화합니다.',
          levers: ['재정', '규제', '데이터/AI'],
          impactScore: 4,
          feasibilityScore: 3,
          evidenceUrl: '#',
          authorName: '에너지정책랩',
          createdAt: Date.now() - 70000,
          supportCount: 6,
          flow: {
            problem: '요금 변동성이 가계 불안을 초래',
            cause: '연동제 가격 전가, 보호장치 미흡',
            strategy: '연동제 유지 + 맞춤형 보호',
            actions: '소득 하위 30% 자동 바우처 증액, 에너지 효율 컨설팅 제공',
            outcome: '재정 부담 분산, 취약계층 보호, 절약 유인 유지'
          }
        }
      ],
      'issue-4': [
        {
          id: 'sol-5',
          issueId: 'issue-4',
          title: '선택적 실명 인증 + AI 필터 결합',
          summary: '선택적 실명 인증 계정에 가중 신뢰도를 부여하고 AI 필터로 악성 게시물을 즉시 차단합니다.',
          levers: ['규제', '데이터/AI', '커뮤니케이션'],
          impactScore: 3,
          feasibilityScore: 4,
          evidenceUrl: '#',
          authorName: '디지털시민',
          createdAt: Date.now() - 60000,
          supportCount: 5,
          flow: {
            problem: '악성 게시물과 신뢰도 하락',
            cause: '익명성 악용, 신고·제재 지연',
            strategy: '신뢰도 기반 노출 + 실시간 필터링',
            actions: '실명 인증 배지 도입, AI 욕설/개인정보 탐지, 신고 보상제',
            outcome: '악성 콘텐츠 감소, 표현의 자유 보존, 이용자 신뢰 회복'
          }
        }
      ]
    };

    const charts = { raw: null, corrected: null, age: null, preview: null, external: null };

    let SOLUTIONS = {};
    let solutionSupportMap = {};
    let votes = [];
    let userProfile = null;
    let userVoteMap = {};
    let currentUser = null;
    let selectedIssueId = null;
    let activeEvidenceTab = 'pro';
    let activeCategory = '전체';
    let activeOpinionTab = 'what';
    let latestMetricsMap = {};

    const SEED_VOTES = [
      { issueId: 'issue-1', choice: '찬성', age_group: '20대', region: '서울/수도권', timestamp: Date.now() - 90000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '30대', region: '서울/수도권', timestamp: Date.now() - 88000 },
      { issueId: 'issue-1', choice: '반대', age_group: '40대', region: '지방', timestamp: Date.now() - 86000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '40대', region: '서울/수도권', timestamp: Date.now() - 84000 },
      { issueId: 'issue-1', choice: '중립', age_group: '50대', region: '지방', timestamp: Date.now() - 82000 },
      { issueId: 'issue-1', choice: '반대', age_group: '60+', region: '지방', timestamp: Date.now() - 80000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '50대', region: '서울/수도권', timestamp: Date.now() - 78000 },
      { issueId: 'issue-1', choice: '중립', age_group: '30대', region: '서울/수도권', timestamp: Date.now() - 76000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '20대', region: '해외', timestamp: Date.now() - 74000 },
      { issueId: 'issue-1', choice: '반대', age_group: '60+', region: '지방', timestamp: Date.now() - 72000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '40대', region: '서울/수도권', timestamp: Date.now() - 70000 },
      { issueId: 'issue-1', choice: '중립', age_group: '10대', region: '서울/수도권', timestamp: Date.now() - 68000 },
      { issueId: 'issue-1', choice: '반대', age_group: '50대', region: '지방', timestamp: Date.now() - 66000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '30대', region: '서울/수도권', timestamp: Date.now() - 64000 },
      { issueId: 'issue-1', choice: '중립', age_group: '40대', region: '해외', timestamp: Date.now() - 62000 },
      { issueId: 'issue-1', choice: '찬성', age_group: '50대', region: '서울/수도권', timestamp: Date.now() - 60000 },
      { issueId: 'issue-1', choice: '반대', age_group: '20대', region: '지방', timestamp: Date.now() - 58000 },
      { issueId: 'issue-1', choice: '중립', age_group: '60+', region: '서울/수도권', timestamp: Date.now() - 56000 },
      { issueId: 'issue-2', choice: '찬성', age_group: '20대', region: '서울/수도권', timestamp: Date.now() - 54000 },
      { issueId: 'issue-2', choice: '찬성', age_group: '30대', region: '서울/수도권', timestamp: Date.now() - 52000 },
      { issueId: 'issue-2', choice: '중립', age_group: '40대', region: '지방', timestamp: Date.now() - 50000 },
      { issueId: 'issue-2', choice: '반대', age_group: '50대', region: '지방', timestamp: Date.now() - 48000 },
      { issueId: 'issue-2', choice: '찬성', age_group: '20대', region: '서울/수도권', timestamp: Date.now() - 46000 },
      { issueId: 'issue-2', choice: '반대', age_group: '60+', region: '서울/수도권', timestamp: Date.now() - 44000 },
      { issueId: 'issue-3', choice: '찬성', age_group: '50대', region: '지방', timestamp: Date.now() - 42000 },
      { issueId: 'issue-3', choice: '반대', age_group: '30대', region: '서울/수도권', timestamp: Date.now() - 40000 },
      { issueId: 'issue-3', choice: '중립', age_group: '40대', region: '해외', timestamp: Date.now() - 38000 },
      { issueId: 'issue-3', choice: '찬성', age_group: '20대', region: '서울/수도권', timestamp: Date.now() - 36000 },
      { issueId: 'issue-3', choice: '반대', age_group: '60+', region: '지방', timestamp: Date.now() - 34000 },
      { issueId: 'issue-4', choice: '반대', age_group: '20대', region: '서울/수도권', timestamp: Date.now() - 32000 },
      { issueId: 'issue-4', choice: '찬성', age_group: '40대', region: '서울/수도권', timestamp: Date.now() - 30000 },
      { issueId: 'issue-4', choice: '중립', age_group: '30대', region: '지방', timestamp: Date.now() - 28000 },
      { issueId: 'issue-4', choice: '반대', age_group: '50대', region: '지방', timestamp: Date.now() - 26000 }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      votes = loadJSON(STORAGE_KEYS.votes, []);
      if (!votes.length) {
        votes = [...SEED_VOTES];
        saveJSON(STORAGE_KEYS.votes, votes);
      }
      SOLUTIONS = loadJSON(SOLUTION_STORAGE_KEYS.solutions, null);
      if (!SOLUTIONS) {
        SOLUTIONS = JSON.parse(JSON.stringify(SEED_SOLUTIONS));
        saveJSON(SOLUTION_STORAGE_KEYS.solutions, SOLUTIONS);
      }
      solutionSupportMap = loadJSON(SOLUTION_STORAGE_KEYS.support, {}) || {};
      userProfile = loadJSON(STORAGE_KEYS.profile, null);
      userVoteMap = loadJSON(STORAGE_KEYS.userVote, {});
      currentUser = loadJSON(STORAGE_KEYS.user, null);
      selectedIssueId = loadJSON('rr-selected-issue', null) || getHotIssue().id;

      bindBaseEvents();
      setupSolutionForm();
      setupOpinionTabs();
      renderAll();

      if (!currentUser) openLoginModal();
      else if (!userProfile) showToast('연령대·거주지를 설정하면 보정 정확도가 올라갑니다.', 'info');
    });

    function bindBaseEvents() {
      document.getElementById('login-kakao').addEventListener('click', () => mockLogin('kakao'));
      document.getElementById('login-naver').addEventListener('click', () => mockLogin('naver'));
      document.getElementById('login-google').addEventListener('click', () => mockLogin('google'));
      document.getElementById('login-email').addEventListener('click', () => mockLogin('email'));
      document.getElementById('btn-open-profile').addEventListener('click', toggleUserPanel);

      const heroCard = document.getElementById('hero-card');
      heroCard?.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        openDetail(getHotIssue().id);
      });
      document.getElementById('btn-hero-vote').addEventListener('click', (e) => { e.stopPropagation(); openDetail(getHotIssue().id); });
      document.getElementById('btn-hero-view').addEventListener('click', (e) => { e.stopPropagation(); openDetail(getHotIssue().id); });

      document.addEventListener('click', (e) => {
        const panel = document.getElementById('user-panel');
        const trigger = document.getElementById('btn-open-profile');
        if (!panel || panel.classList.contains('hidden')) return;
        if (panel.contains(e.target) || trigger.contains(e.target)) return;
        closeUserPanel();
      });
    }

    function setupOpinionTabs() {
      const whatBtn = document.getElementById('what-tab-btn');
      const howBtn = document.getElementById('how-tab-btn');
      if (!whatBtn || !howBtn) return;
      if (!whatBtn.dataset.bound) {
        whatBtn.addEventListener('click', () => switchOpinionTab('what'));
        howBtn.addEventListener('click', () => switchOpinionTab('how'));
        whatBtn.dataset.bound = 'true';
        howBtn.dataset.bound = 'true';
      }
      switchOpinionTab(activeOpinionTab);
    }

    function switchOpinionTab(tab) {
      activeOpinionTab = tab;
      const whatBtn = document.getElementById('what-tab-btn');
      const howBtn = document.getElementById('how-tab-btn');
      const whatPanel = document.getElementById('what-panel');
      const howPanel = document.getElementById('how-panel');
      if (!whatBtn || !howBtn || !whatPanel || !howPanel) return;
      const activeCls = ['bg-white', 'shadow-sm', 'text-slate-900'];
      const inactiveCls = ['text-slate-500'];
      [
        { btn: whatBtn, key: 'what' },
        { btn: howBtn, key: 'how' }
      ].forEach(({ btn, key }) => {
        btn.classList.remove(...activeCls, ...inactiveCls);
        if (tab === key) btn.classList.add(...activeCls);
        else btn.classList.add(...inactiveCls);
      });
      whatPanel.classList.toggle('hidden', tab !== 'what');
      howPanel.classList.toggle('hidden', tab !== 'how');
    }

    function setupSolutionForm() {
      const leverWrap = document.getElementById('lever-options');
      if (leverWrap && !leverWrap.dataset.ready) {
        POLICY_LEVERS.forEach((lever) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.lever = lever;
          btn.dataset.selected = 'false';
          btn.className = 'px-3 py-1.5 rounded-full border border-slate-200 bg-white text-sm font-semibold text-slate-600 hover:-translate-y-0.5 active:scale-95 transition transform';
          btn.innerText = lever;
          btn.addEventListener('click', () => toggleLever(btn));
          leverWrap.appendChild(btn);
        });
        leverWrap.dataset.ready = 'true';
      }
      const submitBtn = document.getElementById('solution-submit');
      if (submitBtn && !submitBtn.dataset.bound) {
        submitBtn.addEventListener('click', handleSolutionSubmit);
        submitBtn.dataset.bound = 'true';
      }
    }

    function toggleLever(btn) {
      if (!btn) return;
      const isSelected = btn.dataset.selected === 'true';
      if (isSelected) {
        btn.dataset.selected = 'false';
        btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-200', 'shadow');
        btn.classList.add('border-slate-200', 'text-slate-600');
      } else {
        btn.dataset.selected = 'true';
        btn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200', 'shadow');
        btn.classList.remove('border-slate-200', 'text-slate-600');
      }
    }

    function openLoginModal() {
      const modal = document.getElementById('login-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeLoginModal() {
      const modal = document.getElementById('login-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function providerLabel(provider) {
      const map = { kakao: '카카오 로그인', naver: '네이버 로그인', google: '구글 로그인', email: '이메일 로그인' };
      return map[provider] || 'Mock 로그인';
    }

    function mockLogin(provider) {
      currentUser = { id: `demo-${provider}-${Date.now()}`, name: '테스트 유저', provider, createdAt: Date.now() };
      saveJSON(STORAGE_KEYS.user, currentUser);
      showToast(`${providerLabel(provider)} 완료 (Mock)`, 'success');
      closeLoginModal();
      closeUserPanel();
      renderUserPanel();
      if (!userProfile) setTimeout(() => openProfileModal(), 200);
    }

    function logout() {
      localStorage.removeItem(STORAGE_KEYS.user);
      localStorage.removeItem(STORAGE_KEYS.profile);
      localStorage.removeItem(STORAGE_KEYS.userVote);
      localStorage.removeItem(STORAGE_KEYS.votes);
      currentUser = null;
      userProfile = null;
      userVoteMap = {};
      votes = [...SEED_VOTES];
      selectedIssueId = getHotIssue().id;
      latestMetricsMap = {};
      renderAll();
      openLoginModal();
      showToast('로그아웃되었습니다.', 'info');
    }

    function toggleUserPanel() {
      if (!ensureLoggedIn()) return;
      renderUserPanel();
      document.getElementById('user-panel').classList.toggle('hidden');
    }

    function closeUserPanel() {
      const panel = document.getElementById('user-panel');
      panel?.classList.add('hidden');
    }

    function renderUserPanel() {
      const panel = document.getElementById('user-panel');
      if (!panel) return;
      if (!currentUser) {
        panel.classList.add('hidden');
        return;
      }
      document.getElementById('user-panel-name').innerText = currentUser.name || 'Mock 유저';
      document.getElementById('user-panel-provider').innerText = providerLabel(currentUser.provider);
      document.getElementById('user-panel-profile').innerText = userProfile ? `${userProfile.ageGroup} · ${userProfile.region}` : '연령·거주지 미입력';
      const issueId = getSelectedIssue().id;
      document.getElementById('user-panel-rep-msg').innerText = getRepresentationHint(issueId);
      document.getElementById('user-panel-rep-tag').innerText = `대표성 ${latestMetricsMap[issueId]?.repScore ?? 0}/100`;
    }

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function ensureLoggedIn() {
      if (!currentUser) {
        showToast('로그인 후 이용해주세요.', 'error');
        openLoginModal();
        return false;
      }
      return true;
    }

    function ensureProfile() {
      if (!ensureLoggedIn()) return false;
      if (!userProfile || !userProfile.ageGroup || !userProfile.region) {
        showToast('연령대와 거주지를 등록해주세요 (Mock 인증)', 'error');
        openProfileModal();
        return false;
      }
      return true;
    }

    function openProfileModal() {
      if (!ensureLoggedIn()) return;
      document.getElementById('profile-age').value = userProfile?.ageGroup || '';
      document.getElementById('profile-region').value = userProfile?.region || '';
      document.getElementById('profile-modal').classList.remove('hidden');
      document.getElementById('profile-modal').classList.add('flex');
    }

    function closeProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function saveProfile() {
      if (!ensureLoggedIn()) return;
      const ageGroup = document.getElementById('profile-age').value;
      const region = document.getElementById('profile-region').value;
      if (!ageGroup || !region) {
        showToast('연령대와 거주지를 모두 선택해주세요.', 'error');
        return;
      }
      userProfile = { ageGroup, region, verifiedKorean: true };
      saveJSON(STORAGE_KEYS.profile, userProfile);
      showToast('인증 정보가 저장되었습니다.', 'success');
      closeProfileModal();
      renderAll();
    }

    function setView(view) {
      ['home', 'detail'].forEach((name) => {
        const el = document.getElementById(`view-${name}`);
        el.classList.add('hidden');
        el.classList.remove('fade-enter-active');
      });
      const target = document.getElementById(`view-${view}`);
      if (!target) return;
      target.classList.remove('hidden');
      target.classList.add('fade-enter');
      setTimeout(() => {
        target.classList.add('fade-enter-active');
        target.classList.remove('fade-enter');
      }, 10);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      closeUserPanel();
    }

    function setSelectedIssue(issueId) {
      selectedIssueId = issueId;
      saveJSON('rr-selected-issue', issueId);
      activeEvidenceTab = 'pro';
    }

    function getHotIssue() {
      return ISSUES.find((i) => i.isHot) || ISSUES[0];
    }

    function getSelectedIssue() {
      return ISSUES.find((i) => i.id === selectedIssueId) || getHotIssue();
    }

    function renderAll() {
      latestMetricsMap = buildIssueMetricsMap();
      renderUserPanel();
      renderHome(latestMetricsMap);
      renderDetail(latestMetricsMap);
    }

    function buildIssueMetricsMap() {
      const map = {};
      ISSUES.forEach((issue) => {
        map[issue.id] = buildIssueMetrics(issue.id);
      });
      return map;
    }

    function buildIssueMetrics(issueId) {
      const issueVotes = votes.filter((v) => v.issueId === issueId);
      const raw = computeRaw(issueVotes);
      const ageStats = computeAgeStats(issueVotes);
      const corrected = computeCorrected(ageStats, raw.total);
      const repScore = computeRepresentationScore(ageStats, raw.total);
      const warnings = buildWarnings(ageStats, raw.total);
      return { raw, ageStats, corrected, repScore, warnings };
    }

    function computeRaw(issueVotes) {
      const counts = { 찬성: 0, 중립: 0, 반대: 0 };
      issueVotes.forEach((v) => { if (counts[v.choice] !== undefined) counts[v.choice] += 1; });
      const total = Object.values(counts).reduce((a, b) => a + b, 0);
      const percents = {};
      Object.entries(counts).forEach(([k, v]) => { percents[k] = total ? Math.round((v / total) * 1000) / 10 : 0; });
      return { counts, percents, total };
    }

    function computeAgeStats(issueVotes) {
      const stats = {};
      AGE_GROUPS.forEach((g) => { stats[g.id] = { total: 0, counts: { 찬성: 0, 중립: 0, 반대: 0 } }; });
      issueVotes.forEach((v) => {
        if (!stats[v.age_group]) return;
        stats[v.age_group].total += 1;
        stats[v.age_group].counts[v.choice] = (stats[v.age_group].counts[v.choice] || 0) + 1;
      });
      return stats;
    }

    function computeCorrected(ageStats, total) {
      const corrected = { 찬성: 0, 중립: 0, 반대: 0 };
      if (!total) return corrected;
      AGE_GROUPS.forEach((group) => {
        const stat = ageStats[group.id];
        if (!stat || !stat.total) return;
        const sampleRatio = stat.total / total;
        const weight = group.populationRatio / sampleRatio;
        ['찬성', '중립', '반대'].forEach((choice) => {
          const share = stat.counts[choice] / stat.total;
          corrected[choice] += share * weight;
        });
      });
      const sum = corrected.찬성 + corrected.중립 + corrected.반대;
      if (!sum) return corrected;
      Object.keys(corrected).forEach((k) => { corrected[k] = Math.round((corrected[k] / sum) * 1000) / 10; });
      return corrected;
    }

    function computeRepresentationScore(ageStats, total) {
      if (!total) return 0;
      let deviation = 0;
      AGE_GROUPS.forEach((group) => {
        const sampleRatio = total ? (ageStats[group.id]?.total || 0) / total : 0;
        deviation += Math.abs(sampleRatio - group.populationRatio);
      });
      const normalized = Math.max(0, 1 - Math.min(1, deviation * 1.2));
      return Math.round(normalized * 100);
    }

    function buildWarnings(ageStats, total) {
      const warnings = [];
      AGE_GROUPS.forEach((group) => {
        const sample = ageStats[group.id]?.total || 0;
        const sampleRatio = total ? sample / total : 0;
        const popRatio = group.populationRatio;
        if (!sample) {
          warnings.push(`${group.label} 참여가 없어 결과가 왜곡될 수 있습니다.`);
          return;
        }
        const factor = sampleRatio / popRatio;
        if (factor >= 1.4) warnings.push(`${group.label} 참여율이 실제 인구보다 ${factor.toFixed(1)}배 높습니다.`);
        if (factor <= 0.6) warnings.push(`${group.label} 참여율이 낮아 보정이 크게 적용됩니다.`);
      });
      if (!warnings.length) warnings.push('연령대 비중이 비교적 균형적입니다. (가중치 적용 후)');
      return warnings;
    }

    function renderHome(metricsMap) {
      const hotIssue = getHotIssue();
      const metrics = metricsMap[hotIssue.id] || buildIssueMetrics(hotIssue.id);
      document.getElementById('home-category').innerText = hotIssue.category;
      document.getElementById('home-title').innerText = hotIssue.title;
      document.getElementById('home-description').innerText = hotIssue.description;
      document.getElementById('home-total').innerText = `${metrics.raw.total.toLocaleString()}명`;
      document.getElementById('home-rep-score').innerText = `${metrics.repScore} / 100`;
      document.getElementById('home-my-vote').innerText = userVoteMap[hotIssue.id] || '대기';
      renderPreview(metrics.raw);
      renderCategoryTabs();
      renderIssueList(metricsMap);
    }

    function renderCategoryTabs() {
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      ISSUE_CATEGORIES.forEach((cat) => {
        const btn = document.createElement('button');
        const active = activeCategory === cat;
        btn.className = `px-3 py-2 rounded-full border text-sm font-semibold whitespace-nowrap ${active ? 'bg-blue-600 text-white border-blue-600 shadow' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300'}`;
        btn.innerText = cat;
        btn.onclick = (e) => {
          e.stopPropagation();
          activeCategory = cat;
          renderCategoryTabs();
          renderIssueList(latestMetricsMap);
        };
        container.appendChild(btn);
      });
    }

    function renderIssueList(metricsMap) {
      const list = document.getElementById('issue-list');
      list.innerHTML = '';
      const filtered = ISSUES.filter((issue) => activeCategory === '전체' || issue.category === activeCategory);
      if (!filtered.length) {
        list.innerHTML = '<div class="bg-white p-4 rounded-2xl border text-sm text-gray-500">해당 카테고리의 이슈가 없습니다.</div>';
        return;
      }
      filtered.forEach((issue) => {
        const metrics = metricsMap[issue.id] || buildIssueMetrics(issue.id);
        const agree = metrics.raw.percents.찬성 || 0;
        const neutral = metrics.raw.percents.중립 || 0;
        const disagree = metrics.raw.percents.반대 || 0;
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:-translate-y-0.5 hover:shadow-md transition duration-150';
        card.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div>
              <p class="text-xs text-gray-500">${issue.category}</p>
              <h3 class="font-bold text-lg text-gray-900">${issue.title}</h3>
              <p class="text-xs text-gray-500 mt-1">${issue.description}</p>
            </div>
            <button class="text-sm text-blue-600 font-semibold" onclick="openDetail('${issue.id}')">자세히</button>
          </div>
          <div class="w-full h-8 bg-gray-100 rounded-full flex overflow-hidden mb-2">
            <div style="width:${agree}%" class="h-full bg-blue-600"></div>
            <div style="width:${neutral}%" class="h-full bg-gray-400"></div>
            <div style="width:${disagree}%" class="h-full bg-red-500"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 font-medium">
            <span class="text-blue-600">찬성 ${agree}%</span>
            <span class="text-gray-600">중립 ${neutral}%</span>
            <span class="text-red-600">반대 ${disagree}%</span>
          </div>
          <div class="mt-2 text-xs text-gray-500">총 ${metrics.raw.total.toLocaleString()}명 · 대표성 ${metrics.repScore}/100</div>`;
        list.appendChild(card);
      });
    }

    function openDetail(issueId) {
      if (issueId) setSelectedIssue(issueId);
      renderAll();
      setView('detail');
    }

    function renderDetail(metricsMap) {
      const issue = getSelectedIssue();
      const metrics = metricsMap[issue.id] || buildIssueMetrics(issue.id);
      const raw = metrics.raw;
      const corrected = metrics.corrected;
      const ageStats = metrics.ageStats;
      const repScore = metrics.repScore;

      document.getElementById('detail-category').innerText = issue.category;
      document.getElementById('detail-title').innerText = issue.title;
      document.getElementById('total-vote-count').innerText = `총 ${raw.total.toLocaleString()}명 참여`;
      document.getElementById('detail-rep-score').innerText = repScore || 0;

      document.getElementById('bar-agree').style.width = `${raw.percents.찬성 || 0}%`;
      document.getElementById('bar-neutral').style.width = `${raw.percents.중립 || 0}%`;
      document.getElementById('bar-disagree').style.width = `${raw.percents.반대 || 0}%`;
      document.getElementById('bar-agree').innerText = raw.percents.찬성 > 5 ? `${raw.percents.찬성}%` : '';
      document.getElementById('bar-neutral').innerText = raw.percents.중립 > 5 ? `${raw.percents.중립}%` : '';
      document.getElementById('bar-disagree').innerText = raw.percents.반대 > 5 ? `${raw.percents.반대}%` : '';
      document.getElementById('percent-agree').innerText = `찬성 ${raw.percents.찬성 || 0}%`;
      document.getElementById('percent-neutral').innerText = `중립 ${raw.percents.중립 || 0}%`;
      document.getElementById('percent-disagree').innerText = `반대 ${raw.percents.반대 || 0}%`;

      const warningBox = document.getElementById('bias-warnings');
      warningBox.innerHTML = '';
      metrics.warnings.forEach((text) => {
        const row = document.createElement('div');
        row.className = 'flex items-start gap-2 text-sm text-gray-700 bg-slate-50 border border-slate-100 px-3 py-2 rounded-xl';
        row.innerHTML = `<span class="material-symbols-outlined text-base text-amber-500">warning</span><span>${text}</span>`;
        warningBox.appendChild(row);
      });

      updateEvidence(issue.id);
      renderComments(issue.id);
      refreshVoteButtons();
      renderCharts(raw, corrected, ageStats);
      renderExternalOpinions(issue.id, metrics);
      renderSolutionFlow(issue.id);
      renderSolutionList(issue.id);
      switchOpinionTab(activeOpinionTab);
    }

    function refreshVoteButtons() {
      ['vote-agree', 'vote-neutral', 'vote-disagree'].forEach((btnId) => {
        const btn = document.getElementById(btnId);
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'border-blue-500', 'border-gray-400', 'border-red-500', 'shadow-md');
      });
      const myVote = userVoteMap[getSelectedIssue().id];
      if (!myVote) return;
      ['vote-agree', 'vote-neutral', 'vote-disagree'].forEach((btnId) => {
        const btn = document.getElementById(btnId);
        if (btnId.includes(myVote === '찬성' ? 'agree' : myVote === '중립' ? 'neutral' : 'disagree')) {
          btn.classList.add('border-blue-500', 'shadow-md');
        } else {
          btn.classList.add('opacity-50');
          btn.disabled = true;
        }
      });
    }

    function updateEvidence(issueId) {
      const list = document.getElementById('evidence-list');
      const data = EVIDENCE[issueId]?.[activeEvidenceTab] || [];
      document.querySelectorAll('.tab-btn').forEach((btn) => {
        btn.classList.remove('border-indigo-600', 'text-indigo-600', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-500', 'font-medium');
      });
      const activeBtn = document.getElementById(`tab-${activeEvidenceTab}`);
      activeBtn.classList.add('border-indigo-600', 'text-indigo-600', 'font-semibold');
      activeBtn.classList.remove('border-transparent', 'text-gray-500', 'font-medium');

      list.innerHTML = '';
      if (!data.length) {
        list.innerHTML = '<div class="bg-gray-50 p-4 rounded-xl text-sm text-gray-500 text-center">등록된 근거가 없습니다.</div>';
        return;
      }
      data.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'p-4 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors';
        card.innerHTML = `
          <div class="flex items-start">
            <span class="material-symbols-outlined text-sm text-indigo-500 mr-2 mt-0.5">link</span>
            <div class="flex-1">
              <p class="text-sm font-semibold text-gray-800 line-clamp-2">${item.title}</p>
              <p class="text-xs text-gray-500 mt-1">${item.source}</p>
            </div>
            <a href="${item.link}" target="_blank" class="ml-3 text-xs text-indigo-500 hover:text-indigo-700 font-medium">원문 보기</a>
          </div>`;
        list.appendChild(card);
      });
    }

    function selectEvidenceTab(type) {
      activeEvidenceTab = type;
      updateEvidence(getSelectedIssue().id);
    }

    function renderComments(issueId) {
      const container = document.getElementById('comment-list');
      const data = COMMENTS[issueId] || [];
      document.getElementById('comment-count').innerText = data.length;
      container.innerHTML = '';
      data.forEach((c) => {
        let color = 'bg-blue-100 text-blue-600';
        if (c.type === '중립') color = 'bg-gray-100 text-gray-600';
        if (c.type === '반대') color = 'bg-red-100 text-red-600';
        const row = document.createElement('div');
        row.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100';
        row.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <span class="px-1.5 py-0.5 rounded ${color} text-[10px] font-bold">${c.type}</span>
            <span class="text-xs text-gray-800 font-semibold">${c.nickname}</span>
            <span class="text-xs text-gray-500 font-medium">${c.meta}</span>
          </div>
          <p class="text-sm text-gray-800 leading-relaxed mb-3">${c.content}</p>
          <div class="flex items-center gap-4 text-xs text-gray-400">
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">thumb_up</span>
              공감 ${c.likes}
            </span>
          </div>`;
        container.appendChild(row);
      });
    }

    function renderSolutionFlow(issueId) {
      const container = document.getElementById('solution-flow');
      if (!container) return;
      container.innerHTML = '';
      const solutions = getSortedSolutions(issueId);
      if (!solutions.length) {
        container.innerHTML = '<div class="bg-white border border-slate-200 rounded-2xl p-3 text-sm text-slate-500 text-center">아직 해결 흐름이 없습니다. 첫 제안을 남겨주세요.</div>';
        return;
      }
      const top = solutions[0];
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between gap-3';
      header.innerHTML = `<div><p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wide">대표 해결책</p><p class="text-base font-bold text-slate-900">${top.title}</p><p class="text-sm text-slate-600 line-clamp-2">${top.summary}</p></div><div class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm font-semibold border border-blue-100">지지 ${top.supportCount || 0}</div>`;
      container.appendChild(header);

      const wrapper = document.createElement('div');
      wrapper.className = 'flex flex-col md:flex-row md:items-stretch gap-3';
      const steps = [
        { label: '문제 정의', value: top.flow?.problem || '' },
        { label: '원인 분석', value: top.flow?.cause || '' },
        { label: '전략', value: top.flow?.strategy || '' },
        { label: '실행', value: top.flow?.actions || '' },
        { label: '결과', value: top.flow?.outcome || '' }
      ];

      steps.forEach((step, idx) => {
        const box = document.createElement('div');
        box.className = 'flex-1 bg-white rounded-2xl border border-slate-200 shadow p-3';
        box.innerHTML = `<p class="text-[11px] text-slate-400 font-semibold uppercase tracking-wide mb-1">${step.label}</p><p class="text-xs md:text-sm text-slate-800 line-clamp-3">${step.value || '작성 대기'}</p>`;
        wrapper.appendChild(box);
        if (idx < steps.length - 1) {
          const arrow = document.createElement('div');
          arrow.className = 'flex items-center justify-center md:justify-center';
          arrow.innerHTML = '<span class="hidden md:block text-slate-300 text-lg">→</span><span class="md:hidden text-slate-400 text-lg">↓</span>';
          wrapper.appendChild(arrow);
        }
      });
      container.appendChild(wrapper);
    }

    function renderSolutionList(issueId) {
      const list = document.getElementById('solution-list');
      if (!list) return;
      list.innerHTML = '';
      const solutions = getSortedSolutions(issueId);
      if (!solutions.length) {
        list.innerHTML = '<div class="bg-white border border-slate-200 rounded-2xl p-4 text-sm text-slate-500 text-center">등록된 해결책이 없습니다. 첫 제안을 남겨주세요.</div>';
        return;
      }
      solutions.forEach((sol) => {
        const levers = (sol.levers || []).map((lever) => `<span class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-[11px] font-semibold border border-blue-100">${lever}</span>`).join('');
        const supportUsers = solutionSupportMap[sol.id] || [];
        const alreadySupported = currentUser?.id ? supportUsers.includes(currentUser.id) : false;
        const card = document.createElement('div');
        card.className = 'bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md hover:-translate-y-0.5 transition p-4';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-bold text-slate-900">${sol.title}</p>
              <p class="text-xs text-slate-600 mt-1">${sol.summary}</p>
              <div class="flex flex-wrap gap-2 mt-2">${levers}</div>
            </div>
            <div class="text-right text-xs text-slate-500">
              <p class="font-semibold text-slate-700">지지 ${sol.supportCount || 0}</p>
              <p>${new Date(sol.createdAt).toLocaleDateString()}</p>
            </div>
          </div>
          <div class="mt-3 space-y-2">
            <div class="flex items-center gap-2 text-xs text-slate-600">
              <span class="font-semibold text-slate-700">예상 효과</span>
              <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500" style="width:${(sol.impactScore || 0) * 20}%;"></div>
              </div>
              <span class="text-[11px] text-slate-500">${sol.impactScore || 0}/5</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-600">
              <span class="font-semibold text-slate-700">실현 가능성</span>
              <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-500" style="width:${(sol.feasibilityScore || 0) * 20}%;"></div>
              </div>
              <span class="text-[11px] text-slate-500">${sol.feasibilityScore || 0}/5</span>
            </div>
          </div>
          <div class="flex items-center justify-between mt-3">
            <div class="text-xs text-blue-600 font-semibold">${sol.evidenceUrl ? `<a href="${sol.evidenceUrl}" target="_blank" class="hover:underline">근거 보기</a>` : '근거 링크 없음'}</div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-slate-500">작성자 ${sol.authorName || '익명'}</span>
              <button class="px-3 py-2 rounded-xl border ${alreadySupported ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-blue-200 text-blue-700 hover:bg-blue-50'} text-sm font-semibold transition" data-support="${sol.id}" ${alreadySupported ? 'disabled' : ''}>${alreadySupported ? '지지 완료' : '지지하기'}</button>
            </div>
          </div>
        `;
        const supportBtn = card.querySelector('[data-support]');
        supportBtn?.addEventListener('click', () => supportSolution(sol.id));
        list.appendChild(card);
      });
    }

    function handleSolutionSubmit() {
      if (!ensureLoggedIn()) return;
      const issueId = getSelectedIssue().id;
      const title = document.getElementById('solution-title')?.value.trim();
      const summary = document.getElementById('solution-summary')?.value.trim();
      const levers = Array.from(document.querySelectorAll('#lever-options [data-lever]')).filter((btn) => btn.dataset.selected === 'true').map((btn) => btn.dataset.lever);
      const impactScore = parseInt(document.getElementById('solution-impact')?.value, 10);
      const feasibilityScore = parseInt(document.getElementById('solution-feasibility')?.value, 10);
      const evidenceUrl = document.getElementById('solution-evidence')?.value.trim();
      const flow = {
        problem: document.getElementById('flow-problem')?.value.trim(),
        cause: document.getElementById('flow-cause')?.value.trim(),
        strategy: document.getElementById('flow-strategy')?.value.trim(),
        actions: document.getElementById('flow-actions')?.value.trim(),
        outcome: document.getElementById('flow-outcome')?.value.trim()
      };
      const missingFlow = Object.values(flow).some((v) => !v);
      if (!title || !summary || !impactScore || !feasibilityScore || missingFlow) {
        showToast('필수 항목을 모두 입력해주세요.', 'error');
        return;
      }
      const newSolution = {
        id: `sol-${Date.now()}`,
        issueId,
        title,
        summary,
        levers,
        impactScore,
        feasibilityScore,
        evidenceUrl,
        authorName: currentUser?.name || '익명',
        createdAt: Date.now(),
        supportCount: 0,
        flow
      };
      SOLUTIONS[issueId] = SOLUTIONS[issueId] || [];
      SOLUTIONS[issueId].unshift(newSolution);
      saveSolutionsToStorage();
      renderSolutionFlow(issueId);
      renderSolutionList(issueId);
      resetSolutionForm();
      switchOpinionTab('how');
      showToast('해결책이 저장되었습니다.', 'success');
    }

    function supportSolution(solutionId) {
      if (!ensureLoggedIn()) return;
      const issueId = findSolutionIssue(solutionId);
      if (!issueId) return;
      const userId = currentUser?.id || 'guest';
      solutionSupportMap[solutionId] = solutionSupportMap[solutionId] || [];
      if (solutionSupportMap[solutionId].includes(userId)) {
        showToast('이미 지지했습니다.', 'error');
        return;
      }
      const target = (SOLUTIONS[issueId] || []).find((s) => s.id === solutionId);
      if (!target) return;
      target.supportCount = (target.supportCount || 0) + 1;
      solutionSupportMap[solutionId].push(userId);
      saveSolutionsToStorage();
      renderSolutionFlow(issueId);
      renderSolutionList(issueId);
      showToast('해결책을 지지했습니다.', 'success');
    }

    function findSolutionIssue(solutionId) {
      return Object.keys(SOLUTIONS).find((issueId) => (SOLUTIONS[issueId] || []).some((s) => s.id === solutionId));
    }

    function getSortedSolutions(issueId) {
      const list = SOLUTIONS[issueId] || [];
      return [...list].sort((a, b) => {
        const supportDiff = (b.supportCount || 0) - (a.supportCount || 0);
        if (supportDiff !== 0) return supportDiff;
        return (b.createdAt || 0) - (a.createdAt || 0);
      });
    }

    function resetSolutionForm() {
      ['solution-title', 'solution-summary', 'solution-impact', 'solution-feasibility', 'solution-evidence', 'flow-problem', 'flow-cause', 'flow-strategy', 'flow-actions', 'flow-outcome'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.querySelectorAll('#lever-options [data-lever]').forEach((btn) => {
        btn.dataset.selected = 'false';
        btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-200', 'shadow');
        btn.classList.add('border-slate-200', 'text-slate-600');
      });
    }

    function saveSolutionsToStorage() {
      saveJSON(SOLUTION_STORAGE_KEYS.solutions, SOLUTIONS);
      saveJSON(SOLUTION_STORAGE_KEYS.support, solutionSupportMap);
    }

    // 외부 SNS 여론(트위터/커뮤니티) 요약 및 프레임 카드 렌더링
    function renderExternalOpinions(issueId, metrics) {
      const cardContainer = document.getElementById('external-narratives');
      const sampleLabel = document.getElementById('external-sample');
      const config = EXTERNAL_OPINIONS[issueId];
      if (!cardContainer || !config) return;
      NARRATIVE_COMMENTS[issueId] = NARRATIVE_COMMENTS[issueId] || {};
      cardContainer.innerHTML = '';
      sampleLabel.innerText = `SNS 샘플 ${config.sampleSize.toLocaleString()}건`;

      const sns = config.snsRatio;
      const platform = {
        찬성: metrics.raw.percents['찬성'] || 0,
        중립: metrics.raw.percents['중립'] || 0,
        반대: metrics.raw.percents['반대'] || 0
      };
      const ctxCanvas = document.getElementById('chart-external');
      if (ctxCanvas) {
        const ctx = ctxCanvas.getContext('2d');
        const chartData = {
          labels: ['플랫폼', 'SNS'],
          datasets: [
            { label: '찬성', data: [platform.찬성 || 0, sns.찬성], backgroundColor: COLORS.찬성, stack: 'ext' },
            { label: '중립', data: [platform.중립 || 0, sns.중립], backgroundColor: COLORS.중립, stack: 'ext' },
            { label: '반대', data: [platform.반대 || 0, sns.반대], backgroundColor: COLORS.반대, stack: 'ext' }
          ]
        };
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x.toFixed(1)}%` } }
          },
          scales: {
            x: { stacked: true, min: 0, max: 100, ticks: { stepSize: 20, callback: (v) => `${v}%` }, grid: { color: 'rgba(148,163,184,0.25)' } },
            y: { stacked: true, grid: { display: false } }
          }
        };
        if (charts.external) {
          charts.external.data = chartData;
          charts.external.options = options;
          charts.external.update();
        } else {
          charts.external = new Chart(ctx, { type: 'bar', data: chartData, options });
        }
      }

      config.narratives.forEach((narrative) => {
        const stanceColor = narrative.stance === '찬성' ? 'bg-blue-100 text-blue-700' : narrative.stance === '반대' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
        const anomalyTag = narrative.isAnomaly ? '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-amber-100 text-amber-700 border border-amber-200">이상 확산 패턴 감지 (Mock)</span>' : '';
        const comments = NARRATIVE_COMMENTS[issueId][narrative.id] || [];
        const card = document.createElement('div');
        card.className = 'bg-gray-50 border border-gray-100 rounded-2xl p-4 hover:-translate-y-0.5 hover:shadow-md transition duration-150';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-2 mb-2">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full text-[10px] font-bold ${stanceColor}">${narrative.stance} 프레임</span>
              ${anomalyTag}
            </div>
            <span class="text-xs text-gray-500">의견수 ${comments.length}개</span>
          </div>
          <p class="font-semibold text-gray-900 mb-1">${narrative.title}</p>
          <p class="text-sm text-gray-600 mb-3">${narrative.summary}</p>
          <div class="flex gap-2 mb-3">
            <button class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:-translate-y-0.5 active:scale-[0.98] transition duration-150" data-action="support">지지 의견 쓰기</button>
            <button class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-semibold hover:-translate-y-0.5 active:scale-[0.98] transition duration-150" data-action="oppose">반박 의견 쓰기</button>
          </div>
          <div class="hidden flex-col gap-2 mb-3" data-form>
            <textarea class="w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500" rows="2" placeholder="한 줄 의견을 입력해주세요."></textarea>
            <button class="self-end px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 active:scale-[0.98] transition duration-150" data-submit>등록</button>
          </div>
          <div class="space-y-2" data-comments></div>
        `;

        const form = card.querySelector('[data-form]');
        const textarea = form.querySelector('textarea');
        const submitBtn = form.querySelector('[data-submit]');
        const commentBox = card.querySelector('[data-comments]');

        const renderCommentList = () => {
          commentBox.innerHTML = '';
          comments.slice(0, 3).forEach((c) => {
            const row = document.createElement('div');
            row.className = 'text-sm text-gray-800 bg-white border border-gray-100 rounded-xl px-3 py-2 flex items-center gap-2';
            row.innerHTML = `<span class="px-1.5 py-0.5 rounded ${c.type === '지지' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'} text-[10px] font-bold">${c.type}</span><span class="font-semibold">${c.nickname}</span><span class="text-gray-500">${c.content}</span>`;
            commentBox.appendChild(row);
          });
        };
        renderCommentList();

        card.querySelector('[data-action="support"]').addEventListener('click', () => {
          form.classList.toggle('hidden');
          form.dataset.type = '지지';
        });
        card.querySelector('[data-action="oppose"]').addEventListener('click', () => {
          form.classList.toggle('hidden');
          form.dataset.type = '반박';
        });
        submitBtn.addEventListener('click', () => {
          const content = textarea.value.trim();
          if (!content) return showToast('내용을 입력해주세요.', 'error');
          const type = form.dataset.type || '지지';
          const nickname = currentUser?.name || '익명';
          comments.unshift({ type, nickname, content, createdAt: Date.now() });
          NARRATIVE_COMMENTS[issueId][narrative.id] = comments;
          textarea.value = '';
          form.classList.add('hidden');
          renderCommentList();
          showToast('의견이 등록되었습니다.', 'success');
        });

        cardContainer.appendChild(card);
      });
    }

    function addCommentFromPrompt() {
      if (!ensureLoggedIn()) return;
      const issueId = getSelectedIssue().id;
      COMMENTS[issueId] = COMMENTS[issueId] || [];
      const voteType = userVoteMap[issueId] || '중립';
      COMMENTS[issueId].unshift({ type: voteType, nickname: '나', meta: `${userProfile?.ageGroup || '연령 미정'} · ${userProfile?.region || '지역 미정'}`, content: '의견을 남겼습니다.', likes: 0 });
      renderComments(issueId);
      showToast('의견이 추가되었습니다. (임시)', 'success');
    }

    function renderPreview(raw) {
      const canvas = document.getElementById('preview-raw');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const data = [raw.percents.찬성 || 0, raw.percents.중립 || 0, raw.percents.반대 || 0];
      const baseConfig = horizontalStackOptions();
      const chartData = {
        labels: ['전체'],
        datasets: [
          { label: '찬성', data: [data[0]], backgroundColor: COLORS.찬성, stack: 'stack1' },
          { label: '중립', data: [data[1]], backgroundColor: COLORS.중립, stack: 'stack1' },
          { label: '반대', data: [data[2]], backgroundColor: COLORS.반대, stack: 'stack1' }
        ]
      };
      if (charts.preview) {
        charts.preview.data = chartData;
        charts.preview.update();
        return;
      }
      charts.preview = new Chart(ctx, { type: 'bar', data: chartData, options: baseConfig });
    }

    function renderCharts(raw, corrected, ageStats) {
      const rawCanvas = document.getElementById('chart-raw');
      const correctedCanvas = document.getElementById('chart-corrected');
      const ageCanvas = document.getElementById('chart-age');
      if (!rawCanvas || !correctedCanvas || !ageCanvas) return;

      const rawCtx = rawCanvas.getContext('2d');
      const correctedCtx = correctedCanvas.getContext('2d');
      const ageCtx = ageCanvas.getContext('2d');
      if (!rawCtx || !correctedCtx || !ageCtx) return;

      const rawPercent = [raw.percents.찬성 || 0, raw.percents.중립 || 0, raw.percents.반대 || 0];
      const correctedPercent = [corrected.찬성 || 0, corrected.중립 || 0, corrected.반대 || 0];

      const baseConfig = horizontalStackOptions();

      const rawData = {
        labels: ['전체'],
        datasets: [
          { label: '찬성', data: [rawPercent[0]], backgroundColor: COLORS.찬성, stack: 'stack1' },
          { label: '중립', data: [rawPercent[1]], backgroundColor: COLORS.중립, stack: 'stack1' },
          { label: '반대', data: [rawPercent[2]], backgroundColor: COLORS.반대, stack: 'stack1' }
        ]
      };

      const correctedData = {
        labels: ['전체'],
        datasets: [
          { label: '찬성', data: [correctedPercent[0]], backgroundColor: COLORS.찬성, stack: 'stack2' },
          { label: '중립', data: [correctedPercent[1]], backgroundColor: COLORS.중립, stack: 'stack2' },
          { label: '반대', data: [correctedPercent[2]], backgroundColor: COLORS.반대, stack: 'stack2' }
        ]
      };

      if (charts.raw) { charts.raw.data = rawData; charts.raw.update(); }
      else { charts.raw = new Chart(rawCtx, { type: 'bar', data: rawData, options: baseConfig }); }

      if (charts.corrected) { charts.corrected.data = correctedData; charts.corrected.update(); }
      else { charts.corrected = new Chart(correctedCtx, { type: 'bar', data: correctedData, options: baseConfig }); }

      const ageLabels = AGE_GROUPS.map((g) => g.label);
      const ageAgree = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.찬성 / stat.total) * 1000) / 10;
      });
      const ageNeutral = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.중립 / stat.total) * 1000) / 10;
      });
      const ageDisagree = ageLabels.map((label) => {
        const stat = ageStats[label];
        if (!stat || !stat.total) return 0;
        return Math.round((stat.counts.반대 / stat.total) * 1000) / 10;
      });

      const ageOptions = {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: (ctx) => `${ctx.label} - ${ctx.dataset.label} ${ctx.parsed.x.toFixed(1)}%` } }
        },
        scales: {
          x: { stacked: true, ticks: { callback: (v) => `${v}%`, stepSize: 20 }, max: 100, min: 0, grid: { color: 'rgba(148,163,184,0.25)' } },
          y: { stacked: true, grid: { display: false } }
        }
      };

      const ageData = {
        labels: ageLabels,
        datasets: [
          { label: '찬성', data: ageAgree, backgroundColor: COLORS.찬성 },
          { label: '중립', data: ageNeutral, backgroundColor: COLORS.중립 },
          { label: '반대', data: ageDisagree, backgroundColor: COLORS.반대 }
        ]
      };

      if (charts.age) { charts.age.data = ageData; charts.age.update(); }
      else { charts.age = new Chart(ageCtx, { type: 'bar', data: ageData, options: ageOptions }); }
    }

    function horizontalStackOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12 } },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x.toFixed(1)}%` } }
        },
        scales: {
          x: { stacked: true, min: 0, max: 100, ticks: { stepSize: 20, callback: (v) => `${v}%` }, grid: { color: 'rgba(148,163,184,0.25)' } },
          y: { stacked: true, display: false }
        }
      };
    }

    function handleVote(type) {
      const choiceMap = { agree: '찬성', neutral: '중립', disagree: '반대' };
      const issueId = getSelectedIssue().id;
      if (!ensureProfile()) return;
      if (userVoteMap[issueId]) {
        showToast('이미 투표했습니다. 결과 화면에서 확인하세요.', 'error');
        setView('detail');
        return;
      }
      const voteRecord = {
        issueId,
        choice: choiceMap[type],
        age_group: userProfile.ageGroup,
        region: userProfile.region,
        timestamp: Date.now(),
        userId: currentUser?.id || 'guest'
      };
      votes.push(voteRecord);
      userVoteMap[issueId] = choiceMap[type];
      saveJSON(STORAGE_KEYS.votes, votes);
      saveJSON(STORAGE_KEYS.userVote, userVoteMap);
      showToast('투표가 저장되었습니다.', 'success');
      renderAll();
      setView('detail');
    }

    function getRepresentationHint(issueId) {
      if (!currentUser) return '로그인 후 대표성 안내가 제공됩니다.';
      if (!userProfile) return '연령대·거주지를 입력하면 대표성 기여도를 보여드립니다.';
      const metrics = latestMetricsMap[issueId] || buildIssueMetrics(issueId);
      const stat = metrics.ageStats[userProfile.ageGroup] || { total: 0 };
      const total = metrics.raw.total || 0;
      const popRatio = AGE_GROUPS.find((g) => g.id === userProfile.ageGroup)?.populationRatio || 0;
      const sampleRatio = total ? (stat.total || 0) / total : 0;
      if (!total) return '아직 표본이 적습니다. 첫 투표로 대표성을 올려주세요.';
      if (sampleRatio < popRatio * 0.6) return '당신의 연령대 참여가 부족해 당신의 한 표가 특히 중요합니다.';
      if (sampleRatio > popRatio * 1.4) return '당신의 연령대는 이미 많이 참여했습니다. 보정이 적용됩니다.';
      return '균형 잡힌 표본입니다. 계속 참여해 주세요.';
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const colorMap = { success: 'bg-emerald-500', error: 'bg-rose-500', info: 'bg-gray-800' };
      toast.className = `${colorMap[type] || colorMap.info} text-white px-3 py-2 rounded-xl shadow-lg text-sm`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-4px)'; }, 2500);
      setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
    }
  </script>
</body>
</html>
